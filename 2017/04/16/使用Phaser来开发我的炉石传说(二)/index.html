<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/Timing-House/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/Timing-House/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/Timing-House/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Phaser,">








  <link rel="shortcut icon" type="image/x-icon" href="/Timing-House/favicon.ico?v=5.1.0">






<meta name="description" content="五.游戏主逻辑接下来我们要做的就是整个游戏的关键了。整个游戏能不能跑起来，就看我们这主逻辑写得咋样了。 游戏主逻辑我们这里分为几个部分：  卡牌的生成与渲染 战斗随从的生成 敌人的AI 战斗结算 水晶费用管理 剩余卡牌的管理">
<meta name="keywords" content="Phaser">
<meta property="og:type" content="article">
<meta property="og:title" content="使用Phaser来开发我的炉石传说(二)">
<meta property="og:url" content="https://sangliang.github.io/Timing-House/2017/04/16/使用Phaser来开发我的炉石传说(二)/index.html">
<meta property="og:site_name" content="Sa&#39;s Timing House">
<meta property="og:description" content="五.游戏主逻辑接下来我们要做的就是整个游戏的关键了。整个游戏能不能跑起来，就看我们这主逻辑写得咋样了。 游戏主逻辑我们这里分为几个部分：  卡牌的生成与渲染 战斗随从的生成 敌人的AI 战斗结算 水晶费用管理 剩余卡牌的管理">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://raw.githubusercontent.com/SangLiang/Blog/gh-pages/pics/201609/29.png">
<meta property="og:image" content="https://raw.githubusercontent.com/SangLiang/Blog/gh-pages/pics/201609/30.png">
<meta property="og:image" content="https://raw.githubusercontent.com/SangLiang/Blog/gh-pages/pics/201609/31.png">
<meta property="og:updated_time" content="2022-03-16T03:31:21.955Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用Phaser来开发我的炉石传说(二)">
<meta name="twitter:description" content="五.游戏主逻辑接下来我们要做的就是整个游戏的关键了。整个游戏能不能跑起来，就看我们这主逻辑写得咋样了。 游戏主逻辑我们这里分为几个部分：  卡牌的生成与渲染 战斗随从的生成 敌人的AI 战斗结算 水晶费用管理 剩余卡牌的管理">
<meta name="twitter:image" content="https://raw.githubusercontent.com/SangLiang/Blog/gh-pages/pics/201609/29.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/Timing-House/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://sangliang.github.io/Timing-House/2017/04/16/使用Phaser来开发我的炉石传说(二)/">





  <title> 使用Phaser来开发我的炉石传说(二) | Sa's Timing House </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  











  <div style="display: none;">
    <script src="//s95.cnzz.com/z_stat.php?id=1261741312&web_id=1261741312" language="JavaScript"></script>
  </div>






  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/Timing-House/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Sa's Timing House</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">Sa 的学习笔记</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/Timing-House/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/Timing-House/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://sangliang.github.io/Timing-House/Timing-House/2017/04/16/使用Phaser来开发我的炉石传说(二)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sa">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/Timing-House/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sa's Timing House">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                使用Phaser来开发我的炉石传说(二)
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T00:00:00+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="五-游戏主逻辑"><a href="#五-游戏主逻辑" class="headerlink" title="五.游戏主逻辑"></a>五.游戏主逻辑</h3><p>接下来我们要做的就是整个游戏的关键了。整个游戏能不能跑起来，就看我们这主逻辑写得咋样了。</p>
<p>游戏主逻辑我们这里分为几个部分：</p>
<ul>
<li>卡牌的生成与渲染</li>
<li>战斗随从的生成</li>
<li>敌人的AI</li>
<li>战斗结算</li>
<li>水晶费用管理</li>
<li>剩余卡牌的管理</li>
</ul>
<a id="more"></a>
<h4 id="1-卡牌的生成与渲染"><a href="#1-卡牌的生成与渲染" class="headerlink" title="1.卡牌的生成与渲染"></a>1.卡牌的生成与渲染</h4><p>我们目前能让除了战斗场景之外的元素都顺利的显示出来了，但是还是有很多不对头的地方。我们手里拿的卡牌统统都还是卡背。这肯定是不对的，我们得让系统给我们生成一套卡组，然后把卡牌正确的样子显示出来。</p>
<p>因为我们这里并没有做玩家的自定义卡组，那么卡组的来源就需要我们想点办法了。这里我们采用的是随机生成卡组的方法。卡牌配置里面运行我们用什么样的卡牌，那么我们就只要生成相应数量的卡牌就是了。</p>
<p>在此之前，我们需要对我们的卡牌的数据进行相关的配置：</p>
<p>在module/config目录下新建一个CardCongfig.js：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 游戏卡牌的配置文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> CardConfig = &#123;</span><br><span class="line">    <span class="string">"card_info"</span>: [&#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"fishman_baby"</span>,</span><br><span class="line">        <span class="string">"fight"</span>: <span class="string">"fishman_baby_fight"</span>,</span><br><span class="line">        <span class="string">"cn_name"</span>: <span class="string">"鱼人宝宝"</span>,</span><br><span class="line">        <span class="string">"fee"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">"attack"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">"hp"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">"id"</span>: <span class="number">1</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"freshwater_crocodile"</span>,</span><br><span class="line">        <span class="string">"fight"</span>: <span class="string">"freshwater_crocodile_fight"</span>,</span><br><span class="line">        <span class="string">"cn_name"</span>: <span class="string">"淡水鳄"</span>,</span><br><span class="line">        <span class="string">"fee"</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="string">"attack"</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="string">"hp"</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="string">"id"</span>: <span class="number">2</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"ogre"</span>,</span><br><span class="line">        <span class="string">"fight"</span>: <span class="string">"ogre_fight"</span>,</span><br><span class="line">        <span class="string">"cn_name"</span>: <span class="string">"食人魔法师"</span>,</span><br><span class="line">        <span class="string">"fee"</span>: <span class="number">4</span>,</span><br><span class="line">        <span class="string">"attack"</span>: <span class="number">4</span>,</span><br><span class="line">        <span class="string">"hp"</span>: <span class="number">4</span>,</span><br><span class="line">        <span class="string">"id"</span>: <span class="number">3</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"dead_wing"</span>,</span><br><span class="line">        <span class="string">"fight"</span>: <span class="string">"dead_wing_fight"</span>,</span><br><span class="line">        <span class="string">"cn_name"</span>: <span class="string">"死亡之翼"</span>,</span><br><span class="line">        <span class="string">"fee"</span>: <span class="number">9</span>,</span><br><span class="line">        <span class="string">"attack"</span>: <span class="number">9</span>,</span><br><span class="line">        <span class="string">"hp"</span>: <span class="number">9</span>,</span><br><span class="line">        <span class="string">"id"</span>: <span class="number">4</span></span><br><span class="line">    &#125;],<span class="comment">// 卡牌的相关信息</span></span><br><span class="line">    <span class="string">"cardLength"</span>: <span class="number">15</span>, <span class="comment">// 卡组长度</span></span><br><span class="line">    <span class="string">"cardInitialLength"</span>: <span class="number">4</span>, <span class="comment">// 初始化手牌长度</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = CardConfig;</span><br></pre></td></tr></table></figure>
<p>以后如果我们有新的卡牌需要添加，就直接往这里面做配置就可以了。</p>
<p>解释下里面卡牌信息的字段： “name”：显示图的key；”fight“，战斗场景中的图片key；”cn_name”，中文名；”fee”，召唤费用；”attack”，攻击力；”hp”，生命值；”id”，唯一id。</p>
<p>卡牌的相关信息配置完成之后，我们现在就能生成手牌了。</p>
<p>手牌的生成方法很简单，比如我们需要生成15张手牌，那么我们只要产生15个在id范围之内的随机数就可以了。然后根据生成的唯一id去我们的config中去寻找相关的信息，然后渲染赋值就可以了。</p>
<p>下面开始来写我们的手牌id生成器，在class目录下创建一个CardGenerater.js：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 卡组生成器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CardGenerator</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 卡组生成器</span></span><br><span class="line"><span class="comment">// @param cardLength [number] 卡组长度</span></span><br><span class="line"><span class="comment">// @param minIndex [number] 最小索引</span></span><br><span class="line"><span class="comment">// @param maxIndex [number] 最大索引</span></span><br><span class="line"><span class="comment">// @return cardList [array] 卡牌id生成数组</span></span><br><span class="line">CardGenerator.prototype.buildCardList = <span class="function"><span class="keyword">function</span> (<span class="params">cardLength, minIndex, maxIndex</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> cardList = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; cardLength; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> ramdom = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * maxIndex) + minIndex;</span><br><span class="line">        cardList.push(ramdom);</span><br><span class="line">        <span class="comment">// console.log(cardList);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cardList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = CardGenerator;</span><br></pre></td></tr></table></figure>
<p>我们后面就可以通过buildCardList这个方法来做随机的id列表生成。</p>
<p>继续开始改写我们的HandCard类，打开HandCard.js:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 手牌类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> CardGenerater = <span class="built_in">require</span>(<span class="string">"./CardGenerater"</span>);</span><br><span class="line"><span class="keyword">var</span> CardConfig = <span class="built_in">require</span>(<span class="string">"../config/CardConfig"</span>);</span><br><span class="line"><span class="keyword">var</span> DataManager = <span class="built_in">require</span>(<span class="string">"./DataManager"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">HandCard</span>(<span class="params">game, x, y</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.cardObjList = []; <span class="comment">// 手牌对象数组</span></span><br><span class="line">    <span class="keyword">this</span>.cardViewList = []; <span class="comment">// 手牌视图数组</span></span><br><span class="line">    <span class="keyword">this</span>.cardIDList = [];</span><br><span class="line">    <span class="keyword">this</span>.x = x || <span class="number">140</span>;</span><br><span class="line">    <span class="keyword">this</span>.y = y || <span class="number">20</span>;</span><br><span class="line">    <span class="keyword">this</span>.init(game);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HandCard.prototype.init = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.cardIDList = <span class="keyword">this</span>.setHandCardList();</span><br><span class="line">    <span class="comment">// this.buildHandCardViewList(game); // 设置卡背</span></span><br><span class="line">    <span class="keyword">this</span>.setRealHandCard(game); <span class="comment">// 真实卡面</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建手牌数组view</span></span><br><span class="line">HandCard.prototype.buildHandCardViewList = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> card = game.add.image(<span class="keyword">this</span>.x + i * <span class="number">70</span>, <span class="keyword">this</span>.y, <span class="string">"card_back"</span>);</span><br><span class="line">        card.scale.set(<span class="number">0.5</span>);</span><br><span class="line">        <span class="keyword">this</span>.cardViewList.push(card);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置卡牌的数据显示</span></span><br><span class="line">HandCard.prototype.setRealHandCard = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _list = <span class="keyword">this</span>.cardIDList.splice(<span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">console</span>.info(_list);</span><br><span class="line">    <span class="built_in">console</span>.info(<span class="keyword">this</span>.cardIDList);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; CardConfig.card_info.length; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (_list[i] == CardConfig.card_info[j].id) &#123;</span><br><span class="line">                <span class="keyword">var</span> card = game.add.image(<span class="keyword">this</span>.x + i * <span class="number">75</span>, <span class="keyword">this</span>.y, CardConfig.card_info[j].name);</span><br><span class="line">                card.cardInfo = &#123;&#125;;</span><br><span class="line">                card.cardInfo.HP = CardConfig.card_info[j].hp; <span class="comment">// 血量</span></span><br><span class="line">                card.cardInfo.attack = CardConfig.card_info[j].attack; <span class="comment">// 攻击力</span></span><br><span class="line">                card.cardInfo.cnName = CardConfig.card_info[j].cn_name; <span class="comment">// 中文名称</span></span><br><span class="line">                card.cardInfo.fee = CardConfig.card_info[j].fee; <span class="comment">// 召唤费用</span></span><br><span class="line">                card.cardInfo.fight = CardConfig.card_info[j].fight; <span class="comment">// 战斗图片</span></span><br><span class="line">                card.scale.set(<span class="number">0.5</span>);</span><br><span class="line">                <span class="keyword">this</span>.cardObjList.push(card);</span><br><span class="line"></span><br><span class="line">                card.inputEnabled = <span class="literal">true</span>;</span><br><span class="line">                card.events.onInputDown.add(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">this</span>.inputEnabled = <span class="literal">false</span>; <span class="comment">// 禁止玩家不停点击</span></span><br><span class="line">                    <span class="keyword">if</span>(DataManager.heroChoiseCard == <span class="literal">null</span> )&#123;</span><br><span class="line">                        DataManager.heroChoiseCard = <span class="keyword">this</span>;</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="keyword">var</span> tween = game.add.tween(DataManager.heroChoiseCard).to(&#123; <span class="attr">y</span>: DataManager.heroChoiseCard.y + <span class="number">20</span> &#125;, <span class="number">200</span>, <span class="string">"Linear"</span>, <span class="literal">true</span>);</span><br><span class="line">                        DataManager.heroChoiseCard.inputEnabled = <span class="literal">true</span>;</span><br><span class="line">                        tween.start();</span><br><span class="line">                        DataManager.heroChoiseCard = <span class="keyword">this</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 点击之后的tween动画配置</span></span><br><span class="line">                    <span class="keyword">var</span> tween = game.add.tween(<span class="keyword">this</span>).to(&#123; <span class="attr">y</span>: <span class="keyword">this</span>.y - <span class="number">20</span> &#125;, <span class="number">200</span>, <span class="string">"Linear"</span>, <span class="literal">true</span>);</span><br><span class="line">                    tween.start(); <span class="comment">// 开始移动</span></span><br><span class="line">                  	<span class="comment">// 回调</span></span><br><span class="line">                    tween.onComplete.add(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                        <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">                    &#125;);</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="keyword">this</span>);</span><br><span class="line">                &#125;, card);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成卡牌id数组</span></span><br><span class="line">HandCard.prototype.setHandCardList = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> cardGenerater = <span class="keyword">new</span> CardGenerater();</span><br><span class="line">    <span class="keyword">var</span> cardIDList = cardGenerater.buildCardList(CardConfig.cardLength, <span class="number">1</span>, CardConfig.card_info.length);</span><br><span class="line">    <span class="keyword">return</span> cardIDList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = HandCard;</span><br></pre></td></tr></table></figure>
<p>这里手牌生成的思路主要是，第一先把我们所有的卡组id列表生成出来，这里是从1到15张，然后从生成好的id列表中去截取数组的前4个部分（这里我们初始化手牌数量为4），然后通过id在CardConfig中去遍历一次，获取相关信息，然后后渲染出来，同时也把获取到的相关信息业赋给我们渲染出来的image对象，这样这张卡牌就拥有了所有我们需要的游戏信息。我们在卡片的点击事件中去打印了被点击的对象自己，相信大家能够在控制台中找到这个对象和我们赋给它的相关数据。</p>
<p>这里我们使用了tween动画，就是在我们点击相应的卡牌后，卡牌会向上平滑位移20个单位，以此来表示我们目前选中的就是该卡牌。tween动画的使用方法也很简单。如果对其参数有不了解的，可以去官网查询api。</p>
<p>这里还有一点需要注意</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DataManager.heroChoiseCard = <span class="keyword">this</span>;</span><br></pre></td></tr></table></figure>
<p>整个游戏的数据管理都是在DataManager中进行的，炉石这个游戏，可以说是完全由数据驱动，棋牌类的游戏可以说基本都是这样，我们通过一个简单的操作，改变了相应的数据，那么整个游戏的逻辑都会对这个数据做出相应的回应，所以，我们需要对数据进行一个比较统一的管理，这里我们使用DataManager作为一个完整游戏数据的管理器。我们来看看这个DataManager是怎么样的。</p>
<p>在class目录下建立一个DataManager.js:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 游戏数据管理类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">var</span> DataManager = &#123;</span><br><span class="line">	turn:<span class="number">0</span>, <span class="comment">// 0代表自己回合,1代表敌人回合 </span></span><br><span class="line">	fee:<span class="number">1</span>, <span class="comment">// 初始化费用，和游戏回合相关</span></span><br><span class="line">	heroChoiseCard:<span class="literal">null</span> <span class="comment">// 英雄选择的卡牌</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = DataManager;</span><br></pre></td></tr></table></figure>
<p>我们目前用到的东西还是不多的。后面我们会把需要的数据慢慢添加进来。</p>
<p>最后，看看我们浏览器中的样子，整个游戏大概是这个样子了：</p>
<p><img src="https://raw.githubusercontent.com/SangLiang/Blog/gh-pages/pics/201609/29.png" alt="image"></p>
<p>我们现在选择卡牌，就会出现相应的动画反馈，并且我们的DataManager也能获取到我们选择的卡牌的信息，很不错，接下来要做的就是我们得把这张我们选择好的卡牌给打出去，而且要在战场上也生成相应的随从。</p>
<p>这时候我们发现，我们现在需要一个新的类来展示我们位于战场上的随从，我们新建一个Fighter.js类。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 战斗元素类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>game </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Fighter</span>(<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.fee = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.hp = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.attack = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.status = <span class="literal">false</span>; <span class="comment">// 随从状态</span></span><br><span class="line">    <span class="keyword">this</span>.fightObj = []; <span class="comment">// 战斗随从数组</span></span><br><span class="line">    <span class="keyword">this</span>.x = <span class="number">150</span>;</span><br><span class="line">    <span class="keyword">this</span>.y = game.world.centerY + <span class="number">30</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Fighter.prototype.init = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成战斗随从</span></span><br><span class="line">Fighter.prototype.buildFighter = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> fightBg = game.add.image(<span class="keyword">this</span>.x, <span class="keyword">this</span>.y, <span class="string">"fishman_baby_fight"</span>);</span><br><span class="line">    <span class="keyword">this</span>.fightObj.push(fightBg);</span><br><span class="line">    <span class="keyword">this</span>.reListObjs();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Fighter.prototype.reListObjs = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.fightObj.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果随从的队列为空，不进行排序</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 重排战斗随从的数组</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.fightObj.length; i++) &#123;</span><br><span class="line">            <span class="keyword">this</span>.fightObj[i].x = <span class="keyword">this</span>.x + i * <span class="number">95</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = Fighter;</span><br></pre></td></tr></table></figure>
<p>老套路，我们还得有个HeroFighter类来继承这个类，在class目录下新建一个HeroFighter.js:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Hero战斗随从</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> Fighter = <span class="built_in">require</span>(<span class="string">"./Fighter"</span>);</span><br><span class="line"><span class="keyword">var</span> utils = <span class="built_in">require</span>(<span class="string">"../Utils"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">HeroFighter</span>(<span class="params">game</span>)</span>&#123;</span><br><span class="line">    Fighter.apply(<span class="keyword">this</span>,<span class="built_in">arguments</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">utils.extend(HeroFighter,Fighter);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = HeroFighter;</span><br></pre></td></tr></table></figure>
<p>有了基本的显示逻辑之后，我们要在UIManager中去触发这个出牌的事件，打开UIManager.js,找到出牌的按钮：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 出牌按钮</span></span><br><span class="line">UIManager.prototype.setShotCardButton = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> shot = game.add.image(<span class="number">80</span>, game.world.centerY - <span class="number">10</span>, <span class="string">"shot_card"</span>);</span><br><span class="line">    shot.anchor.set(<span class="number">0.5</span>);</span><br><span class="line">    shot.inputEnabled = <span class="literal">true</span>;</span><br><span class="line">    shot.events.onInputDown.add(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 如果是敌人回合，那么无法出牌</span></span><br><span class="line">        <span class="keyword">if</span> (DataManager.turn != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"我出牌了"</span>);</span><br><span class="line">        <span class="keyword">if</span> (DataManager.heroChoiseCard) &#123;</span><br><span class="line">            <span class="comment">// 生成出牌后的随从</span></span><br><span class="line">            <span class="keyword">if</span> (DataManager.heroFighters == <span class="literal">null</span>) &#123;</span><br><span class="line">                DataManager.heroFighters = <span class="keyword">new</span> HeroFighter(game);</span><br><span class="line">                DataManager.heroFighters.buildFighter(game);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                DataManager.heroFighters.buildFighter(game);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 销毁出牌后的手牌</span></span><br><span class="line">            DataManager.heroChoiseCard.destroy();</span><br><span class="line">            DataManager.heroChoiseCard = <span class="literal">null</span>;</span><br><span class="line">            <span class="built_in">console</span>.log(DataManager.heroChoiseCard);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> shot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样我们出牌之后，所有被放置在战场中的随从都可以正确的排开来显示，而不会重复挤在一个坐标。但是同时我们也发现了问题，就是我们的手牌也需要这样的功能，当我们出牌之后，手牌可能会出现一些空缺的位置，我们得把空缺的位置给补上，不然就太难看了。这时候我们得重构一下我的UIManager了，由于我们有了管理所有游戏数据的DataManager，那么我们就把在UIManager中实例化的一些本地数据要改为由DataManager所管理的游戏数据了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">UIManager.prototype.init = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.backgroundObj = <span class="keyword">this</span>.setBackGround(game);  <span class="comment">// 生成背景图</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.heroHeadObj = <span class="keyword">new</span> HeroHead(game, <span class="string">"fighter_hero"</span>, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">// 生成玩家英雄头像</span></span><br><span class="line">    <span class="keyword">this</span>.enemyHeadObj = <span class="keyword">new</span> EnemyHead(game, <span class="string">"fighter_hero"</span>, <span class="number">0</span>, game.world.height - <span class="number">140</span>); <span class="comment">// 生成电脑英雄头像</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.turnOverButton = <span class="keyword">this</span>.setTurnOverButton(game); <span class="comment">// 设置回合结束按钮</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.enemyHandCardObj = <span class="keyword">new</span> EnemyHandCard(game); <span class="comment">// 设置敌人手牌</span></span><br><span class="line">    DataManager.heroHandCard = <span class="keyword">new</span> HeroHandCard(game, <span class="literal">null</span>, game.world.height - <span class="number">120</span>); <span class="comment">// 设置玩家手牌</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.shotCardButton = <span class="keyword">this</span>.setShotCardButton(game); <span class="comment">// 设置出牌按钮</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.heroFeeObj = <span class="keyword">new</span> HeroFee(game, game.world.width - <span class="number">110</span>, game.world.centerY + <span class="number">42</span>); <span class="comment">// 英雄费用管理</span></span><br><span class="line">    <span class="keyword">this</span>.enemyFeeObj = <span class="keyword">new</span> EnemyFee(game, game.world.width - <span class="number">110</span>, game.world.centerY - <span class="number">90</span>); <span class="comment">// 敌人费用管理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们得把上面所有涉及到数据结算的对象全部抽出，放在DataManager中进行统一的管理。</p>
<p>改完之后的DataManager:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 游戏数据管理类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> DataManager = &#123;</span><br><span class="line">	turn: <span class="number">0</span>, <span class="comment">// 0代表自己回合,1代表敌人回合 </span></span><br><span class="line">	fee: <span class="number">1</span>, <span class="comment">// 初始化费用，和游戏回合相关</span></span><br><span class="line"></span><br><span class="line">	heroChoiseCard: <span class="literal">null</span>, <span class="comment">// 英雄选择的卡牌</span></span><br><span class="line">	heroFighters: <span class="literal">null</span>, <span class="comment">// 英雄随从</span></span><br><span class="line">	heroHandCard: <span class="literal">null</span>, <span class="comment">// 英雄手牌</span></span><br><span class="line">	heroFee: <span class="literal">null</span>, <span class="comment">// 英雄的费用</span></span><br><span class="line">	heroHead: <span class="literal">null</span>, <span class="comment">// 英雄头像</span></span><br><span class="line"></span><br><span class="line">	enemyHandCard: <span class="literal">null</span>, <span class="comment">// 敌人手牌 </span></span><br><span class="line">	enemyFee: <span class="literal">null</span>, <span class="comment">// 敌人的费用</span></span><br><span class="line">	enemyHead: <span class="literal">null</span> <span class="comment">// 敌人的头像</span></span><br><span class="line">  	turnOverButton:<span class="literal">null</span> <span class="comment">// 回合结束的按钮</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = DataManager;</span><br></pre></td></tr></table></figure>
<p>然后把UIManager中的相关的数据也要做下更新：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">UIManager.prototype.init = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.backgroundObj = <span class="keyword">this</span>.setBackGround(game);  <span class="comment">// 生成背景图</span></span><br><span class="line"></span><br><span class="line">    DataManager.heroHead = <span class="keyword">new</span> HeroHead(game, <span class="string">"fighter_hero"</span>, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">// 生成玩家英雄头像</span></span><br><span class="line">    DataManager.enemyHead = <span class="keyword">new</span> EnemyHead(game, <span class="string">"fighter_hero"</span>, <span class="number">0</span>, game.world.height - <span class="number">140</span>); <span class="comment">// 生成电脑英雄头像</span></span><br><span class="line"></span><br><span class="line">    DataManager.turnOverButton = <span class="keyword">this</span>.setTurnOverButton(game); <span class="comment">// 设置回合结束按钮</span></span><br><span class="line"></span><br><span class="line">    DataManager.enemyHandCard = <span class="keyword">new</span> EnemyHandCard(game); <span class="comment">// 设置敌人手牌</span></span><br><span class="line">    DataManager.heroHandCard = <span class="keyword">new</span> HeroHandCard(game, <span class="literal">null</span>, game.world.height - <span class="number">120</span>); <span class="comment">// 设置玩家手牌</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.shotCardButton = <span class="keyword">this</span>.setShotCardButton(game); <span class="comment">// 设置出牌按钮</span></span><br><span class="line"></span><br><span class="line">    DataManager.heroFee = <span class="keyword">new</span> HeroFee(game, game.world.width - <span class="number">110</span>, game.world.centerY + <span class="number">42</span>); <span class="comment">// 英雄费用管理</span></span><br><span class="line">    DataManager.enemyFee = <span class="keyword">new</span> EnemyFee(game, game.world.width - <span class="number">110</span>, game.world.centerY - <span class="number">90</span>); <span class="comment">// 敌人费用管理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好的，继续回到我们之前的问题，我们得开始给我们的手牌进行排序整理以填补打出去的牌所留下来的坑位，打开HandCard.js:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 重新对手牌排序</span></span><br><span class="line">HandCard.prototype.reListHandCard = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> _temp = [];</span><br><span class="line">    <span class="keyword">if</span> (self.cardObjList.length == <span class="number">0</span>) &#123; <span class="comment">// 没有手牌的情况</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; self.cardObjList.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (self.cardObjList[i].alive == <span class="literal">true</span>) &#123; <span class="comment">// 清除掉已经销毁了的手牌</span></span><br><span class="line">                _temp.push(self.cardObjList[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        self.cardObjList = _temp;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; self.cardObjList.length; j++) &#123; <span class="comment">// 重新对手牌排序</span></span><br><span class="line">            self.cardObjList[j].x = self.x + j * <span class="number">75</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在这个类中加入这个方法，首先是判断手牌是否还存在，如果不存在了，排序肯定就是无法进行的，然后是更新排序的数组，由于我们的手牌对象在打出后就被销毁了，虽然我们看不见他，但是在我们的数组引用中他还是存在的，所以我们要便利我们的手牌数组引用，来确定属性alive为false的对象不在包含在数组之中。</p>
<p>这样，这个重排手牌的函数就算是完成了。最后别忘记了在UIManager中去适时的执行他。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * UI界面管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> BackGround = <span class="built_in">require</span>(<span class="string">"./BackGround"</span>);</span><br><span class="line"><span class="keyword">var</span> HeroHead = <span class="built_in">require</span>(<span class="string">"./HeroHead"</span>);</span><br><span class="line"><span class="keyword">var</span> EnemyHead = <span class="built_in">require</span>(<span class="string">"./EnemyHead"</span>);</span><br><span class="line"><span class="keyword">var</span> DataManager = <span class="built_in">require</span>(<span class="string">"./DataManager"</span>);</span><br><span class="line"><span class="keyword">var</span> HeroHandCard = <span class="built_in">require</span>(<span class="string">"./HeroHandCard"</span>);</span><br><span class="line"><span class="keyword">var</span> EnemyHandCard = <span class="built_in">require</span>(<span class="string">"./EnemyHandCard"</span>);</span><br><span class="line"><span class="keyword">var</span> HeroFee = <span class="built_in">require</span>(<span class="string">"./HeroFee"</span>);</span><br><span class="line"><span class="keyword">var</span> EnemyFee = <span class="built_in">require</span>(<span class="string">"./EnemyFee"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> HeroFighter = <span class="built_in">require</span>(<span class="string">"./HeroFighter"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UIManager</span>(<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.backgroundObj = <span class="literal">null</span>; <span class="comment">// 背景图</span></span><br><span class="line">    <span class="keyword">this</span>.turnOverButton = <span class="literal">null</span>; <span class="comment">// 回合结束</span></span><br><span class="line">    <span class="keyword">this</span>.shotCardButton = <span class="literal">null</span>; <span class="comment">// 出牌按钮</span></span><br><span class="line">    <span class="keyword">this</span>.init(game);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">UIManager.prototype.init = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.backgroundObj = <span class="keyword">this</span>.setBackGround(game);  <span class="comment">// 生成背景图</span></span><br><span class="line"></span><br><span class="line">    DataManager.heroHead = <span class="keyword">new</span> HeroHead(game, <span class="string">"fighter_hero"</span>, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">// 生成玩家英雄头像</span></span><br><span class="line">    DataManager.enemyHead = <span class="keyword">new</span> EnemyHead(game, <span class="string">"fighter_hero"</span>, <span class="number">0</span>, game.world.height - <span class="number">140</span>); <span class="comment">// 生成电脑英雄头像</span></span><br><span class="line"></span><br><span class="line">    DataManager.turnOverButton = <span class="keyword">this</span>.setTurnOverButton(game); <span class="comment">// 设置回合结束按钮</span></span><br><span class="line"></span><br><span class="line">    DataManager.enemyHandCard = <span class="keyword">new</span> EnemyHandCard(game); <span class="comment">// 设置敌人手牌</span></span><br><span class="line">    DataManager.heroHandCard = <span class="keyword">new</span> HeroHandCard(game, <span class="literal">null</span>, game.world.height - <span class="number">120</span>); <span class="comment">// 设置玩家手牌</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.shotCardButton = <span class="keyword">this</span>.setShotCardButton(game); <span class="comment">// 设置出牌按钮</span></span><br><span class="line"></span><br><span class="line">    DataManager.heroFee = <span class="keyword">new</span> HeroFee(game, game.world.width - <span class="number">110</span>, game.world.centerY + <span class="number">42</span>); <span class="comment">// 英雄费用管理</span></span><br><span class="line">    DataManager.enemyFee = <span class="keyword">new</span> EnemyFee(game, game.world.width - <span class="number">110</span>, game.world.centerY - <span class="number">90</span>); <span class="comment">// 敌人费用管理</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置背景</span></span><br><span class="line">UIManager.prototype.setBackGround = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> background = <span class="keyword">new</span> BackGround(game);</span><br><span class="line">    <span class="keyword">return</span> background;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 回合结束</span></span><br><span class="line">UIManager.prototype.setTurnOverButton = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> button = game.add.image(game.world.width - <span class="number">150</span>, game.world.centerY - <span class="number">30</span>, <span class="string">"hero_turn_button"</span>);</span><br><span class="line">    button.inputEnabled = <span class="literal">true</span>;</span><br><span class="line">    button.events.onInputDown.add(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DataManager.turn == <span class="number">0</span>) &#123;</span><br><span class="line">            button.loadTexture(<span class="string">"enemy_turn_button"</span>);</span><br><span class="line">            DataManager.turn = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> button;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 出牌按钮</span></span><br><span class="line">UIManager.prototype.setShotCardButton = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> shot = game.add.image(<span class="number">80</span>, game.world.centerY - <span class="number">10</span>, <span class="string">"shot_card"</span>);</span><br><span class="line">    shot.anchor.set(<span class="number">0.5</span>);</span><br><span class="line">    shot.inputEnabled = <span class="literal">true</span>;</span><br><span class="line">    shot.events.onInputDown.add(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DataManager.turn != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"我出牌了"</span>);</span><br><span class="line">        <span class="keyword">if</span> (DataManager.heroChoiseCard) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DataManager.heroFighters == <span class="literal">null</span>) &#123;</span><br><span class="line">                DataManager.heroFighters = <span class="keyword">new</span> HeroFighter(game);</span><br><span class="line">                DataManager.heroFighters.buildFighter(game);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                DataManager.heroFighters.buildFighter(game);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            DataManager.heroChoiseCard.destroy();</span><br><span class="line">            DataManager.heroHandCard.reListHandCard();</span><br><span class="line">            DataManager.heroChoiseCard = <span class="literal">null</span>;</span><br><span class="line">            <span class="built_in">console</span>.log(DataManager.heroChoiseCard);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> shot;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = UIManager;</span><br></pre></td></tr></table></figure>
<p>那么现在整个界面就想下图所示啦:</p>
<p><img src="https://raw.githubusercontent.com/SangLiang/Blog/gh-pages/pics/201609/30.png" alt="image"></p>
<h4 id="2-战斗随从的生成"><a href="#2-战斗随从的生成" class="headerlink" title="2.战斗随从的生成"></a>2.战斗随从的生成</h4><p>回过头来看看，其实关于战斗随从的生成我们在上一个小节中已经实现了一部分了。但是现在我们通过手牌所生成的战斗随从是不正确的（我们把数据都是写死的）。我们接下来要做的事情是，得生成一个数据完全符合我们预期的战斗随从。这个战斗随从得有生命值，攻击力等属性。</p>
<p>战斗随从的生成思路也很简单，因为我们之前就把我们需要的数据都已经存到了手牌对象之中，那么只要我们拿到我们所出的那张牌，也就拿到了随从的所有信息，战场随从的生成也就是一件很简单的事情了。</p>
<p>如果还记得我们在之前实现手牌类的时候所做的数据处理，大家就回发现，其实这里我们可以直接拿这个数据来用，而不用再到配置表中去读那些数据了。</p>
<p>打开Fighter.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 战斗元素类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>game </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>x [number] 初始化的</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Fighter</span>(<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.fightObj = []; <span class="comment">// 战斗随从数组</span></span><br><span class="line">    <span class="keyword">this</span>.x = <span class="number">150</span>;</span><br><span class="line">    <span class="keyword">this</span>.y = game.world.centerY + <span class="number">30</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Fighter.prototype.init = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成战斗随从</span></span><br><span class="line">Fighter.prototype.buildFighter = <span class="function"><span class="keyword">function</span> (<span class="params">game, hp, attack, cnName, picName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> fightBg = game.add.image(<span class="keyword">this</span>.x, <span class="keyword">this</span>.y, picName);</span><br><span class="line"></span><br><span class="line">    fightBg.hp = hp;</span><br><span class="line">    fightBg.attack = attack;</span><br><span class="line">    fightBg.cnName = cnName;</span><br><span class="line">    fightBg.picName = picName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> _style = &#123;</span><br><span class="line">        fill: <span class="string">"#fff"</span>,</span><br><span class="line">        fontSize: <span class="string">"12pt"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置生命值</span></span><br><span class="line">    <span class="keyword">var</span> hp_text = game.add.text(<span class="number">75</span>, <span class="number">105</span>, hp, _style);</span><br><span class="line">    hp_text.anchor.set(<span class="number">0.5</span>);</span><br><span class="line">    hp_text.key = <span class="string">"hp"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置</span></span><br><span class="line">    <span class="keyword">var</span> attack_text = game.add.text(<span class="number">17</span>, <span class="number">105</span>, attack, _style);</span><br><span class="line">    attack_text.anchor.set(<span class="number">0.5</span>);</span><br><span class="line">    attack_text.key = <span class="string">"attack"</span>;</span><br><span class="line"></span><br><span class="line">    fightBg.addChild(attack_text);</span><br><span class="line">    fightBg.addChild(hp_text);</span><br><span class="line">    <span class="keyword">this</span>.fightObj.push(fightBg);</span><br><span class="line">    <span class="keyword">this</span>.reListObjs();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Fighter.prototype.reListObjs = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.fightObj.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果随从的队列为空，不进行排序</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 重排战斗随从的数组</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.fightObj.length; i++) &#123;</span><br><span class="line">            <span class="keyword">this</span>.fightObj[i].x = <span class="keyword">this</span>.x + i * <span class="number">95</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = Fighter;</span><br></pre></td></tr></table></figure>
<p>我们这里主要是重写了buildFighter这个方法，我们在执行这个函数的时候传入了相应的参数来实现数据的正确绑定，最后在出牌的方法中加入相关的参数即可了：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 出牌按钮</span></span><br><span class="line">UIManager.prototype.setShotCardButton = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> shot = game.add.image(<span class="number">80</span>, game.world.centerY - <span class="number">10</span>, <span class="string">"shot_card"</span>);</span><br><span class="line">    shot.anchor.set(<span class="number">0.5</span>);</span><br><span class="line">    shot.inputEnabled = <span class="literal">true</span>;</span><br><span class="line">    shot.events.onInputDown.add(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DataManager.turn != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"我出牌了"</span>);</span><br><span class="line">        <span class="keyword">if</span> (DataManager.heroChoiseCard) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DataManager.heroFighters == <span class="literal">null</span>) &#123;</span><br><span class="line">                DataManager.heroFighters = <span class="keyword">new</span> HeroFighter(game);</span><br><span class="line">                DataManager.heroFighters.buildFighter(game, DataManager.heroChoiseCard.cardInfo.HP, DataManager.heroChoiseCard.cardInfo.attack, DataManager.heroChoiseCard.cardInfo.cnName, DataManager.heroChoiseCard.cardInfo.fight);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                DataManager.heroFighters.buildFighter(game, DataManager.heroChoiseCard.cardInfo.HP, DataManager.heroChoiseCard.cardInfo.attack, DataManager.heroChoiseCard.cardInfo.cnName, DataManager.heroChoiseCard.cardInfo.fight);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            DataManager.heroChoiseCard.destroy();</span><br><span class="line">            DataManager.heroHandCard.reListHandCard();</span><br><span class="line">            DataManager.heroChoiseCard = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> shot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此，我们的手牌生成和随从生成的主要功能就做完了。接下来要做的事情是我比较喜欢的:电脑的AI。</p>
<h4 id="3-AI"><a href="#3-AI" class="headerlink" title="3.AI"></a>3.AI</h4><p>我其实本人一直都对AI挺感兴趣的。只可惜水平有限，在这里实现的这些所谓的AI都是采用的普通简单决策树算法，简单来说就是if else算法。根据一些我们能预料到的已知情况，再来做出相应的决策，其实我个人对机器学习的一些算法还是很感兴趣的，后面如果有机会会用有监督或者无监督的算法来改良这个AI(也可能就是说说而已)。</p>
<p>不废话了，我们现开始在class中建立一个AI.js类：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 电脑AI</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AI</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 选择手牌</span></span><br><span class="line">AI.prototype.choiseCard = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 选择要攻击的目标</span></span><br><span class="line">AI.prototype.choiseAttackTarget = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = AI;</span><br></pre></td></tr></table></figure>
<p>我现在也不清楚这个AI要做些啥，那么就先扔几个必须要做的函数进去。出牌你是肯定要做的吧，还有随从的攻击也肯定是要有的吧。其他的不知道的功能我们就后面慢慢来补充。</p>
<p>这个时候我们得开始整理下我们的代码了。我们把HandCard.js修改下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">HandCard.prototype.init = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.cardIDList = <span class="keyword">this</span>.setHandCardList();</span><br><span class="line">    <span class="comment">// this.buildHandCardViewList(game); // 设置卡背</span></span><br><span class="line">    <span class="comment">// this.setRealHandCard(game); // 真实卡面</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们把在init中的手牌生成函数全给注释掉,在我们的游戏中，敌人的牌是看不到的，所以在EnemyHandCard中腰调用的是设置卡背的方法，在HeroHandCard类中调用的是能看到卡牌所有信息的设置真实卡面的方法。</p>
<p>这里我们还的修改下我们的设置卡背方法，虽然我们看不到卡面的信息，但是这个信息应该是真实存在的，而且也应该是准确无误的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 构建手牌数组view</span></span><br><span class="line">HandCard.prototype.buildHandCardViewList = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 截取卡组中的前四张</span></span><br><span class="line">    <span class="keyword">var</span> _list = <span class="keyword">this</span>.cardIDList.splice(<span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; CardConfig.card_info.length; j++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (_list[i] == CardConfig.card_info[j].id) &#123;</span><br><span class="line">                <span class="keyword">var</span> card = game.add.image(<span class="keyword">this</span>.x + i * <span class="number">70</span>, <span class="keyword">this</span>.y, <span class="string">"card_back"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 设置相应的数据</span></span><br><span class="line">                card.cardInfo = &#123;&#125;;</span><br><span class="line">                card.cardInfo.HP = CardConfig.card_info[j].hp; <span class="comment">// 血量</span></span><br><span class="line">                card.cardInfo.attack = CardConfig.card_info[j].attack; <span class="comment">// 攻击力</span></span><br><span class="line">                card.cardInfo.cnName = CardConfig.card_info[j].cn_name; <span class="comment">// 中文名称</span></span><br><span class="line">                card.cardInfo.fee = CardConfig.card_info[j].fee; <span class="comment">// 召唤费用</span></span><br><span class="line">                card.cardInfo.fight = CardConfig.card_info[j].fight; <span class="comment">// 战斗图片</span></span><br><span class="line">                card.scale.set(<span class="number">0.5</span>);</span><br><span class="line">                <span class="keyword">this</span>.cardViewList.push(card);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ok,这里其实和设置真实卡面的函数是非常相似的。除了在设置显示图片的事件响应两者有些不同的逻辑，其他的都是一样的。</p>
<p>最后看下HeroHandCard:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 英雄的手牌类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> HandCarnd = <span class="built_in">require</span>(<span class="string">"./HandCard"</span>);</span><br><span class="line"><span class="keyword">var</span> utils = <span class="built_in">require</span>(<span class="string">"../Utils"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">HeroHandCard</span>(<span class="params">game, x, y</span>) </span>&#123;</span><br><span class="line">    HandCarnd.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    <span class="keyword">this</span>.setRealHandCard(game); <span class="comment">// 真实卡面</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">utils.extend(HeroHandCard, HandCarnd);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = HeroHandCard;</span><br></pre></td></tr></table></figure>
<p>EnemyHandCard.js:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 敌人的手牌类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> HandCarnd = <span class="built_in">require</span>(<span class="string">"./HandCard"</span>);</span><br><span class="line"><span class="keyword">var</span> utils = <span class="built_in">require</span>(<span class="string">"../Utils"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">EnemyHandCard</span>(<span class="params">game</span>) </span>&#123;</span><br><span class="line">    HandCarnd.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    <span class="comment">// this.setRealHandCard(game); // 真实卡面</span></span><br><span class="line">    <span class="keyword">this</span>.buildHandCardViewList(game); <span class="comment">// 设置卡背</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">utils.extend(EnemyHandCard, HandCarnd);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = EnemyHandCard;</span><br></pre></td></tr></table></figure>
<p>走到这一步我们手牌设置还没完，我们看看我们的敌人手牌和英雄手牌。两个类使用的手牌对象管理数组是不同的（一个是cardObjList,另一个是cardViewList），所以在EnemyHandCard类中我们还需要重写reListHandCard这个方法，最后我们的EnemyHandCard应该是这样的:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 敌人的手牌类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> HandCarnd = <span class="built_in">require</span>(<span class="string">"./HandCard"</span>);</span><br><span class="line"><span class="keyword">var</span> utils = <span class="built_in">require</span>(<span class="string">"../Utils"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">EnemyHandCard</span>(<span class="params">game</span>) </span>&#123;</span><br><span class="line">    HandCarnd.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    <span class="comment">// this.setRealHandCard(game); // 真实卡面</span></span><br><span class="line">    <span class="keyword">this</span>.buildHandCardViewList(game); <span class="comment">// 设置卡背</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">utils.extend(EnemyHandCard, HandCarnd);</span><br><span class="line"></span><br><span class="line"><span class="comment">// @override  </span></span><br><span class="line"><span class="comment">// 重写relistHandCard方法</span></span><br><span class="line">EnemyHandCard.prototype.reListHandCard = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> _temp = [];</span><br><span class="line">    <span class="built_in">console</span>.log(self.cardViewList);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (self.cardViewList.length == <span class="number">0</span>) &#123; <span class="comment">// 没有手牌的情况</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; self.cardViewList.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (self.cardViewList[i].alive == <span class="literal">true</span>) &#123; <span class="comment">// 清除掉已经销毁了的手牌</span></span><br><span class="line">                _temp.push(self.cardViewList[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        self.cardViewList = _temp;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; self.cardViewList.length; j++) &#123; <span class="comment">// 重新对手牌排序</span></span><br><span class="line">            self.cardViewList[j].x = self.x + j * <span class="number">70</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = EnemyHandCard;</span><br></pre></td></tr></table></figure>
<p>这样就基本上能保证AI所出的牌都能正确的实例化为战场上的随从对象了。接下来我们就得继续写我们AI逻辑了。打开AI.js:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 电脑AI</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> DataManager = <span class="built_in">require</span>(<span class="string">"./DataManager"</span>);</span><br><span class="line"><span class="keyword">var</span> EnemyFighter = <span class="built_in">require</span>(<span class="string">"./EnemyFighter"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AI</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.enemyChoise = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 出牌</span></span><br><span class="line">AI.prototype.shotCard = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.enemyChoise = <span class="keyword">this</span>.choiseCard();</span><br><span class="line">    DataManager.turn = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">this</span>.enemyChoise)&#123;</span><br><span class="line">        <span class="comment">// 没有合适的卡牌</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DataManager.enemyFighters == <span class="literal">null</span>) &#123;</span><br><span class="line">        DataManager.enemyFighters = <span class="keyword">new</span> EnemyFighter(game);</span><br><span class="line">        DataManager.enemyFighters.buildFighter(game, <span class="keyword">this</span>.enemyChoise.cardInfo.HP, <span class="keyword">this</span>.enemyChoise.cardInfo.attack, <span class="keyword">this</span>.enemyChoise.cardInfo.cnName, <span class="keyword">this</span>.enemyChoise.cardInfo.fight);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        DataManager.enemyFighters.buildFighter(game, <span class="keyword">this</span>.enemyChoise.cardInfo.HP, <span class="keyword">this</span>.enemyChoise.cardInfo.attack, <span class="keyword">this</span>.enemyChoise.cardInfo.cnName, <span class="keyword">this</span>.enemyChoise.cardInfo.fight);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.enemyChoise.destroy();</span><br><span class="line">    DataManager.enemyHandCard.reListHandCard();</span><br><span class="line">    <span class="keyword">this</span>.enemyChoise = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    DataManager.turnOverButton.loadTexture(<span class="string">"hero_turn_button"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 选择手牌</span></span><br><span class="line">AI.prototype.choiseCard = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> shotList = [];</span><br><span class="line">    <span class="keyword">var</span> _fee = <span class="built_in">parseInt</span>(DataManager.enemyFee.feeObj.text.split(<span class="string">"/"</span>)[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; DataManager.enemyHandCard.cardViewList.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_fee &gt;= DataManager.enemyHandCard.cardViewList[i].cardInfo.fee) &#123;</span><br><span class="line">            <span class="comment">// 只要费用允许，就放入可出的牌之中</span></span><br><span class="line">            shotList.push(DataManager.enemyHandCard.cardViewList[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shotList.length &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(shotList);</span><br><span class="line">        <span class="comment">// 返回左手第一张牌</span></span><br><span class="line">        <span class="keyword">return</span> shotList[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 选择要攻击的目标</span></span><br><span class="line">AI.prototype.choiseAttackTarget = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = AI;</span><br></pre></td></tr></table></figure>
<p>这里的AI的逻辑看起来应该是挺熟悉的，因为他是完全模拟了我们真人出牌的情景。首先是选择一张手上符合要求的卡牌(这里只要费用是允许的，既为符合要求的卡牌)。然后用我们的enemyChoise来储存这张卡的信息，最后将其实例为化为一个战场随从。</p>
<p>当然，别忘了新建一个EnemyFighter类来管理战场上的随从：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 敌人的战场随从</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> utils = <span class="built_in">require</span>(<span class="string">"../Utils"</span>);</span><br><span class="line"><span class="keyword">var</span> Fighter = <span class="built_in">require</span>(<span class="string">"./Fighter"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">EnemyFighter</span>(<span class="params">game</span>) </span>&#123;</span><br><span class="line">    Fighter.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    <span class="keyword">this</span>.y = game.world.centerY - <span class="number">130</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">utils.extend(EnemyFighter, Fighter);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = EnemyFighter;</span><br></pre></td></tr></table></figure>
<p>由于敌人出牌的逻辑运行是在玩家出完牌之后，而且是在玩家按下了会合结束按钮之后，所以这个出牌的整个逻辑，我们就写在这个按钮按下之后的事件响应中去，打开UIManager,找到setTurnOverButton方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 回合结束</span></span><br><span class="line">UIManager.prototype.setTurnOverButton = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> button = game.add.image(game.world.width - <span class="number">150</span>, game.world.centerY - <span class="number">30</span>, <span class="string">"hero_turn_button"</span>);</span><br><span class="line">    button.inputEnabled = <span class="literal">true</span>;</span><br><span class="line">    button.events.onInputDown.add(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DataManager.turn == <span class="number">0</span>) &#123;</span><br><span class="line">            button.loadTexture(<span class="string">"enemy_turn_button"</span>);</span><br><span class="line">            DataManager.turn = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DataManager.AI.shotCard();</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>直接加上DataManager.AI.shotCard方法就可以了。当然，我们按下按钮，然后敌人马上就把牌扔了出来，这个反应时间有点太快了，玩家可能难以反应过来，我们得加个定时器来做下延迟：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 回合结束</span></span><br><span class="line">UIManager.prototype.setTurnOverButton = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> button = game.add.image(game.world.width - <span class="number">150</span>, game.world.centerY - <span class="number">30</span>, <span class="string">"hero_turn_button"</span>);</span><br><span class="line">    button.inputEnabled = <span class="literal">true</span>;</span><br><span class="line">    button.events.onInputDown.add(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DataManager.turn == <span class="number">0</span>) &#123;</span><br><span class="line">            button.loadTexture(<span class="string">"enemy_turn_button"</span>);</span><br><span class="line">            DataManager.turn = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> time = setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            DataManager.AI.shotCard(game);</span><br><span class="line">            clearTimeout(time);</span><br><span class="line">        &#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> button;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，敌人就像有所思考的出牌了。</p>
<p>最后看下我们的DataManager中的数据情况：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 游戏数据管理类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> DataManager = &#123;</span><br><span class="line">	turn: <span class="number">0</span>, <span class="comment">// 0代表自己回合,1代表敌人回合 </span></span><br><span class="line">	fee: <span class="number">1</span>, <span class="comment">// 初始化费用，和游戏回合相关</span></span><br><span class="line">	AI: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">	heroChoiseCard: <span class="literal">null</span>, <span class="comment">// 英雄选择的卡牌</span></span><br><span class="line">	heroFighters: <span class="literal">null</span>, <span class="comment">// 英雄随从</span></span><br><span class="line">	heroHandCard: <span class="literal">null</span>, <span class="comment">// 英雄手牌</span></span><br><span class="line">	heroFee: <span class="literal">null</span>, <span class="comment">// 英雄的费用</span></span><br><span class="line">	heroHead: <span class="literal">null</span>, <span class="comment">// 英雄头像</span></span><br><span class="line"></span><br><span class="line">	enemyHandCard: <span class="literal">null</span>, <span class="comment">// 敌人手牌 </span></span><br><span class="line">	enemyFee: <span class="literal">null</span>, <span class="comment">// 敌人的费用</span></span><br><span class="line">	enemyHead: <span class="literal">null</span>, <span class="comment">// 敌人的头像</span></span><br><span class="line">	enemyFighters:<span class="literal">null</span>, <span class="comment">// 敌人战场的随从</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	turnOverButton:<span class="literal">null</span> <span class="comment">// 回合结束的按钮</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = DataManager;</span><br></pre></td></tr></table></figure>
<p>ok，到这里，AI简单的出牌逻辑就搞定了。现在你可以和AI一起来斗斗牌了，哈哈。接下来我们要做的事情就是战斗结算（包括AI的战斗逻辑）和一些费用的管理了。</p>
<p><img src="https://raw.githubusercontent.com/SangLiang/Blog/gh-pages/pics/201609/31.png" alt="image"></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/Timing-House/tags/Phaser/" rel="tag"># Phaser</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/Timing-House/2017/04/15/使用Phaser来开发我的炉石传说(一)/" rel="next" title="使用Phaser来开发我的炉石传说(一)">
                <i class="fa fa-chevron-left"></i> 使用Phaser来开发我的炉石传说(一)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/Timing-House/2017/04/17/使用Phaser来开发我的炉石传说(三 最终篇)/" rel="prev" title="使用Phaser来开发我的炉石传说(三 最终篇)">
                使用Phaser来开发我的炉石传说(三 最终篇) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/Timing-House/images/avatar.gif" alt="Sa">
          <p class="site-author-name" itemprop="name">Sa</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/Timing-House/archives">
                <span class="site-state-item-count">43</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Sangliang" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="378305868@qq.com" target="_blank" title="Email">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Email
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#五-游戏主逻辑"><span class="nav-number">1.</span> <span class="nav-text">五.游戏主逻辑</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-卡牌的生成与渲染"><span class="nav-number">1.1.</span> <span class="nav-text">1.卡牌的生成与渲染</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-战斗随从的生成"><span class="nav-number">1.2.</span> <span class="nav-text">2.战斗随从的生成</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-AI"><span class="nav-number">1.3.</span> <span class="nav-text">3.AI</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sa</span>
</div>



        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  








  
  <script type="text/javascript" src="/Timing-House/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/Timing-House/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/Timing-House/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/Timing-House/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/Timing-House/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/Timing-House/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/Timing-House/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/Timing-House/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/Timing-House/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/Timing-House/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/Timing-House/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  

</body>
</html>
