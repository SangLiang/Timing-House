<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/Timing-House/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/Timing-House/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/Timing-House/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Phaser,">








  <link rel="shortcut icon" type="image/x-icon" href="/Timing-House/favicon.ico?v=5.1.0">






<meta name="description" content="4.战斗逻辑战斗逻辑可以说是我们游戏核心中的核心了。实现起来也不是很复杂，这里先交待一下思路。 战斗，无非就是战场上随从之间和玩家英雄之前的属性数据的一些结算而已。我的鳄鱼攻击你的鱼人宝宝，那么我的鳄鱼生命值就减去你的鱼人宝宝随从的攻击力，如果为负，说明鳄鱼人宝宝的攻击力大于我们的鳄鱼随从的攻击力，那么鳄鱼就会阵亡。鱼人宝宝同样要做相同的结算，如果鱼人宝宝的生命值大于鳄鱼的攻击力，那么承受这次攻击">
<meta name="keywords" content="Phaser">
<meta property="og:type" content="article">
<meta property="og:title" content="使用Phaser来开发我的炉石传说(三 最终篇)">
<meta property="og:url" content="https://sangliang.github.io/Timing-House/2017/04/17/使用Phaser来开发我的炉石传说(三 最终篇)/index.html">
<meta property="og:site_name" content="Sa&#39;s Timing House">
<meta property="og:description" content="4.战斗逻辑战斗逻辑可以说是我们游戏核心中的核心了。实现起来也不是很复杂，这里先交待一下思路。 战斗，无非就是战场上随从之间和玩家英雄之前的属性数据的一些结算而已。我的鳄鱼攻击你的鱼人宝宝，那么我的鳄鱼生命值就减去你的鱼人宝宝随从的攻击力，如果为负，说明鳄鱼人宝宝的攻击力大于我们的鳄鱼随从的攻击力，那么鳄鱼就会阵亡。鱼人宝宝同样要做相同的结算，如果鱼人宝宝的生命值大于鳄鱼的攻击力，那么承受这次攻击">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://raw.githubusercontent.com/SangLiang/Blog/gh-pages/pics/201609/32.gif">
<meta property="og:image" content="https://raw.githubusercontent.com/SangLiang/Blog/gh-pages/pics/201609/33.gif">
<meta property="og:updated_time" content="2022-03-16T03:31:21.954Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用Phaser来开发我的炉石传说(三 最终篇)">
<meta name="twitter:description" content="4.战斗逻辑战斗逻辑可以说是我们游戏核心中的核心了。实现起来也不是很复杂，这里先交待一下思路。 战斗，无非就是战场上随从之间和玩家英雄之前的属性数据的一些结算而已。我的鳄鱼攻击你的鱼人宝宝，那么我的鳄鱼生命值就减去你的鱼人宝宝随从的攻击力，如果为负，说明鳄鱼人宝宝的攻击力大于我们的鳄鱼随从的攻击力，那么鳄鱼就会阵亡。鱼人宝宝同样要做相同的结算，如果鱼人宝宝的生命值大于鳄鱼的攻击力，那么承受这次攻击">
<meta name="twitter:image" content="https://raw.githubusercontent.com/SangLiang/Blog/gh-pages/pics/201609/32.gif">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/Timing-House/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://sangliang.github.io/Timing-House/2017/04/17/使用Phaser来开发我的炉石传说(三 最终篇)/">





  <title> 使用Phaser来开发我的炉石传说(三 最终篇) | Sa's Timing House </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  











  <div style="display: none;">
    <script src="//s95.cnzz.com/z_stat.php?id=1261741312&web_id=1261741312" language="JavaScript"></script>
  </div>






  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/Timing-House/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Sa's Timing House</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">Sa 的学习笔记</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/Timing-House/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/Timing-House/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://sangliang.github.io/Timing-House/Timing-House/2017/04/17/使用Phaser来开发我的炉石传说(三 最终篇)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sa">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/Timing-House/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sa's Timing House">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                使用Phaser来开发我的炉石传说(三 最终篇)
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-17T00:00:00+08:00">
                2017-04-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h4 id="4-战斗逻辑"><a href="#4-战斗逻辑" class="headerlink" title="4.战斗逻辑"></a>4.战斗逻辑</h4><p>战斗逻辑可以说是我们游戏核心中的核心了。实现起来也不是很复杂，这里先交待一下思路。</p>
<p>战斗，无非就是战场上随从之间和玩家英雄之前的属性数据的一些结算而已。我的鳄鱼攻击你的鱼人宝宝，那么我的鳄鱼生命值就减去你的鱼人宝宝随从的攻击力，如果为负，说明鳄鱼人宝宝的攻击力大于我们的鳄鱼随从的攻击力，那么鳄鱼就会阵亡。鱼人宝宝同样要做相同的结算，如果鱼人宝宝的生命值大于鳄鱼的攻击力，那么承受这次攻击之后，鱼人宝宝并不会阵亡，但要将生命值进行更新，也就是鱼人宝宝的最新生命值应该是之前生命值减去鳄鱼的攻击力才对。如果攻击的目标是英雄，直接用英雄的血量去减去攻击者的攻击力。当英雄的血量降到1点以下时（不包含1点），那么英雄也就阵亡，游戏的胜负也就分出来了。</p>
<a id="more"></a>
<p>ok，了解规则之后，我们看看当前游戏中的战斗逻辑的触发点。</p>
<ul>
<li>1、当我们攻击敌方的战场随从时，会触发战斗结算</li>
<li>2、当我们攻击敌方英雄本体时，会触发战斗结算</li>
<li>3、当敌人攻击我们的战场随从时，会触发战斗结算</li>
<li>4、当敌人攻击我们的英雄本体时，会触发战斗结算</li>
</ul>
<p>ok,弄明白这四种结算触发点之后，我们就可以开始来写逻辑了。</p>
<p>首先要做的第一件事，就是要把战场上随从的状态表示出来。战场上的随从有两种状态，休眠状态和激活状态。被召唤上场的随从第一回合是无法进行攻击的，需要用休眠状态来表示，在第二个回合，上一回合被召唤出来处于休眠状态的随从就可以发动攻击了，在他攻击完之后，又用进入休眠状态，直到下一个回合解除休眠。</p>
<p>来看下我们对Fighter.js类的修改：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 战斗元素类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>game </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>x [number] 初始化的</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Fighter</span>(<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.fightObj = []; <span class="comment">// 战斗随从数组</span></span><br><span class="line">    <span class="keyword">this</span>.x = <span class="number">150</span>;</span><br><span class="line">    <span class="keyword">this</span>.y = game.world.centerY + <span class="number">30</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Fighter.prototype.init = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成战斗随从</span></span><br><span class="line">Fighter.prototype.buildFighter = <span class="function"><span class="keyword">function</span> (<span class="params">game, hp, attack, cnName, picName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> fightBg = game.add.image(<span class="keyword">this</span>.x, <span class="keyword">this</span>.y, picName);</span><br><span class="line"></span><br><span class="line">    fightBg.hp = hp;</span><br><span class="line">    fightBg.attack = attack;</span><br><span class="line">    fightBg.cnName = cnName;</span><br><span class="line">    fightBg.picName = picName;</span><br><span class="line">    fightBg.sleep = <span class="literal">true</span>; <span class="comment">// 休眠状态，在出牌的第一回合无法进行攻击</span></span><br><span class="line">    <span class="keyword">var</span> _style = &#123;</span><br><span class="line">        fill: <span class="string">"#fff"</span>,</span><br><span class="line">        fontSize: <span class="string">"12pt"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置生命值</span></span><br><span class="line">    <span class="keyword">var</span> hp_text = game.add.text(<span class="number">75</span>, <span class="number">105</span>, hp, _style);</span><br><span class="line">    hp_text.anchor.set(<span class="number">0.5</span>);</span><br><span class="line">    hp_text.key = <span class="string">"hp"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置</span></span><br><span class="line">    <span class="keyword">var</span> attack_text = game.add.text(<span class="number">17</span>, <span class="number">105</span>, attack, _style);</span><br><span class="line">    attack_text.anchor.set(<span class="number">0.5</span>);</span><br><span class="line">    attack_text.key = <span class="string">"attack"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> attack_tag = game.add.image(<span class="number">48</span>, <span class="number">-15</span>, <span class="string">"attack_icon"</span>);</span><br><span class="line">    attack_tag.key = <span class="string">"attack_tag"</span>;</span><br><span class="line">    attack_tag.scale.set(<span class="number">0.5</span>);</span><br><span class="line">    attack_tag.anchor.set(<span class="number">0.5</span>);</span><br><span class="line">    attack_tag.alpha = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    fightBg.addChild(attack_text);</span><br><span class="line">    fightBg.addChild(hp_text);</span><br><span class="line">    fightBg.addChild(attack_tag);</span><br><span class="line">    fightBg.alpha = <span class="number">0.7</span>; <span class="comment">// sleep状态无法攻击</span></span><br><span class="line">    <span class="keyword">this</span>.fightObj.push(fightBg);</span><br><span class="line">    <span class="keyword">this</span>.reListObjs();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Fighter.prototype.reListObjs = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.fightObj.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果随从的队列为空，不进行排序</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 重排战斗随从的数组</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.fightObj.length; i++) &#123;</span><br><span class="line">            <span class="keyword">this</span>.fightObj[i].x = <span class="keyword">this</span>.x + i * <span class="number">95</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Fighter.prototype.awakeFighter = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.fightObj.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.fightObj.length; i++) &#123;</span><br><span class="line">            <span class="keyword">this</span>.fightObj[i].sleep = <span class="literal">false</span>; <span class="comment">// 解除睡眠状态</span></span><br><span class="line">            <span class="keyword">this</span>.fightObj[i].alpha = <span class="number">1</span>; <span class="comment">// 解除睡眠状态后的view</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = Fighter;</span><br></pre></td></tr></table></figure>
<p>这里我们在buildFighter函数中新加了一个attack_tag图片，并且暂时将其隐藏了起来。这个图标是为了我们后面选择战斗随从而作标记的。并且我们将fightBg的默认alpha设为了0.7，这样，当我们的随从被第一次召唤出来的时候，就会以半透明显示了。只有当随从进入激活状态，也就是半透明不为1时，才能进行相关操作。</p>
<p>后面的awakeFighter是在每个回合开始之前唤醒我们的随从的方法。</p>
<p>最后在UIManager中激活我们的睡眠随从。</p>
<p>UIManager.js:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 回合结束</span></span><br><span class="line">UIManager.prototype.setTurnOverButton = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> button = game.add.image(game.world.width - <span class="number">150</span>, game.world.centerY - <span class="number">30</span>, <span class="string">"hero_turn_button"</span>);</span><br><span class="line">    button.inputEnabled = <span class="literal">true</span>;</span><br><span class="line">    button.events.onInputDown.add(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DataManager.turn == <span class="number">0</span>) &#123;</span><br><span class="line">            button.loadTexture(<span class="string">"enemy_turn_button"</span>);</span><br><span class="line">            DataManager.turn = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DataManager.enemyFighters) &#123;</span><br><span class="line">            DataManager.enemyFighters.awakeFighter(); <span class="comment">// 解除敌人随从睡眠状态</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> time = setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            DataManager.AI.shotCard(game);</span><br><span class="line">            DataManager.heroFighters.awakeFighter(); <span class="comment">// 解除玩家随从睡眠状态</span></span><br><span class="line">            clearTimeout(time);</span><br><span class="line">        &#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> button;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写到做到这里，我们开始要写战斗随从之间的战斗了。首先要把我方的随从激活，我们选择了哪个随从，那么拿到该随从的资料，然后再选择敌人的随从，两者作数据的相关结算。</p>
<p>看下我们Fighter.js类：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 战斗元素类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>game </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>x [number] 初始化的</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> DataManager = <span class="built_in">require</span>(<span class="string">"./DataManager"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Fighter</span>(<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.fightObj = []; <span class="comment">// 战斗随从数组</span></span><br><span class="line">    <span class="keyword">this</span>.x = <span class="number">150</span>;</span><br><span class="line">    <span class="keyword">this</span>.y = game.world.centerY + <span class="number">30</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Fighter.prototype.init = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成战斗随从</span></span><br><span class="line">Fighter.prototype.buildFighter = <span class="function"><span class="keyword">function</span> (<span class="params">game, hp, attack, cnName, picName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> fightBg = game.add.image(<span class="keyword">this</span>.x, <span class="keyword">this</span>.y, picName);</span><br><span class="line"></span><br><span class="line">    fightBg.hp = hp;</span><br><span class="line">    fightBg.attack = attack;</span><br><span class="line">    fightBg.cnName = cnName;</span><br><span class="line">    fightBg.picName = picName;</span><br><span class="line">    fightBg.sleep = <span class="literal">true</span>; <span class="comment">// 休眠状态，在出牌的第一回合无法进行攻击</span></span><br><span class="line">    <span class="keyword">var</span> _style = &#123;</span><br><span class="line">        fill: <span class="string">"#fff"</span>,</span><br><span class="line">        fontSize: <span class="string">"12pt"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置生命值</span></span><br><span class="line">    <span class="keyword">var</span> hp_text = game.add.text(<span class="number">75</span>, <span class="number">105</span>, hp, _style);</span><br><span class="line">    hp_text.anchor.set(<span class="number">0.5</span>);</span><br><span class="line">    hp_text.key = <span class="string">"hp"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置</span></span><br><span class="line">    <span class="keyword">var</span> attack_text = game.add.text(<span class="number">17</span>, <span class="number">105</span>, attack, _style);</span><br><span class="line">    attack_text.anchor.set(<span class="number">0.5</span>);</span><br><span class="line">    attack_text.key = <span class="string">"attack"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> attack_tag = game.add.image(<span class="number">48</span>, <span class="number">-15</span>, <span class="string">"attack_icon"</span>);</span><br><span class="line">    attack_tag.key = <span class="string">"attack_tag"</span>;</span><br><span class="line">    attack_tag.scale.set(<span class="number">0.5</span>);</span><br><span class="line">    attack_tag.anchor.set(<span class="number">0.5</span>);</span><br><span class="line">    attack_tag.alpha = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    fightBg.addChild(attack_text);</span><br><span class="line">    fightBg.addChild(hp_text);</span><br><span class="line">    fightBg.addChild(attack_tag);</span><br><span class="line">    fightBg.alpha = <span class="number">0.7</span>; <span class="comment">// sleep状态无法攻击</span></span><br><span class="line">    <span class="keyword">this</span>.fightObj.push(fightBg);</span><br><span class="line">    <span class="keyword">this</span>.reListObjs();</span><br><span class="line"></span><br><span class="line">    fightBg.inputEnabled = <span class="literal">true</span>;</span><br><span class="line">    fightBg.events.onInputDown.add(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.choiceFighter(fightBg);</span><br><span class="line">    &#125;, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Fighter.prototype.reListObjs = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.fightObj.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果随从的队列为空，不进行排序</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> _temp= [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">0</span>; j&lt;<span class="keyword">this</span>.fightObj.length;j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.fightObj[j].alive == <span class="literal">true</span>)&#123;</span><br><span class="line">                _temp.push(<span class="keyword">this</span>.fightObj[j]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.fightObj = _temp;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 重排战斗随从的数组</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.fightObj.length; i++) &#123;</span><br><span class="line">            <span class="keyword">this</span>.fightObj[i].x = <span class="keyword">this</span>.x + i * <span class="number">95</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Fighter.prototype.awakeFighter = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.fightObj.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.fightObj.length; i++) &#123;</span><br><span class="line">            <span class="keyword">this</span>.fightObj[i].sleep = <span class="literal">false</span>; <span class="comment">// 解除睡眠状态</span></span><br><span class="line">            <span class="keyword">this</span>.fightObj[i].alpha = <span class="number">1</span>; <span class="comment">// 解除睡眠状态后的view</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Fighter.prototype.choiceFighter = <span class="function"><span class="keyword">function</span> (<span class="params">fightBg</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (fightBg.sleep == <span class="literal">true</span>) &#123;</span><br><span class="line">        alert(<span class="string">"本回合无法操作该随从！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.fightObj.length; i++) &#123;</span><br><span class="line">            <span class="keyword">this</span>.fightObj[i].children[<span class="number">2</span>].alpha = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        fightBg.children[<span class="number">2</span>].alpha = <span class="number">1</span>;</span><br><span class="line">        DataManager.heroFighterChoise = fightBg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = Fighter;</span><br></pre></td></tr></table></figure>
<p>这里我们引入了DataManager.js，因为我们的很多的数据处理需要在这个对象中进行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">heroFighterChoise:<span class="literal">null</span>, <span class="comment">// 战斗随从的选择</span></span><br></pre></td></tr></table></figure>
<p>同时，也在DataManager中加入这个玩家随从选择的管理对象。</p>
<p>由于我们是无法操纵敌人的战场随从的，而且在点击敌人的随从之后所触发的是战斗的结算。这里我们就需要在EnemyFighter.js类中，去重写choiceFighter方法。</p>
<p>打开EnemyFighter.js:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 重写choiseFighter </span></span><br><span class="line"><span class="comment">// 在玩家选择敌方随从时进行战斗结算</span></span><br><span class="line">EnemyFighter.prototype.choiceFighter = <span class="function"><span class="keyword">function</span> (<span class="params">fightBg</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DataManager.heroFighterChoise == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        alert(<span class="string">"我方的"</span> + DataManager.heroFighterChoise.cnName + <span class="string">"攻击了敌人的"</span> + fightBg.cnName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> _heroFightHP = DataManager.heroFighterChoise.hp - fightBg.attack;</span><br><span class="line">        <span class="keyword">var</span> _enemyFightHP = fightBg.hp - DataManager.heroFighterChoise.attack;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(_heroFightHP,_enemyFightHP);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新玩家的随从的hp</span></span><br><span class="line">        DataManager.heroFighterChoise.hp = _heroFightHP;</span><br><span class="line">        DataManager.heroFighterChoise.alpha = <span class="number">0.7</span>;</span><br><span class="line">        DataManager.heroFighterChoise.sleep = <span class="literal">true</span>;</span><br><span class="line">        DataManager.heroFighterChoise.children[<span class="number">2</span>].alpha = <span class="number">0</span>;</span><br><span class="line">        DataManager.heroFighterChoise.children[<span class="number">1</span>].setText(_heroFightHP);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新敌人的玩家的hp</span></span><br><span class="line">        fightBg.hp = _enemyFightHP;</span><br><span class="line">        fightBg.children[<span class="number">1</span>].setText(_enemyFightHP);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_heroFightHP &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            DataManager.heroFighterChoise.destroy();</span><br><span class="line">            DataManager.heroFighters.reListObjs();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_enemyFightHP &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            fightBg.destroy();</span><br><span class="line">            DataManager.enemyFighters.reListObjs();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DataManager.heroFighterChoise = <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>做完随从之间的战斗逻辑，还有一个对英雄造成伤害的逻辑结算。</p>
<p>打开我们的EnemyHead.js类：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 敌人头像</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> utils = <span class="built_in">require</span>(<span class="string">"../Utils"</span>);</span><br><span class="line"><span class="keyword">var</span> Head = <span class="built_in">require</span>(<span class="string">"./Head"</span>);</span><br><span class="line"><span class="keyword">var</span> DataManager = <span class="built_in">require</span>(<span class="string">"./DataManager"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">EnemyHead</span>(<span class="params">game, textureName, positionX, positionY</span>) </span>&#123;</span><br><span class="line">    Head.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置敌人头像</span></span><br><span class="line"><span class="comment">// 重写setPic</span></span><br><span class="line">Head.prototype.setPic = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> pic = game.add.image(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">this</span>.textureName);</span><br><span class="line"></span><br><span class="line">    pic.inputEnabled = <span class="literal">true</span>;</span><br><span class="line">    pic.events.onInputDown.add(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DataManager.heroFighterChoise == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> _hp = <span class="built_in">parseInt</span>(<span class="keyword">this</span>.HPObj.text) - DataManager.heroFighterChoise.attack;</span><br><span class="line">            <span class="keyword">this</span>.HPObj.setText(_hp);</span><br><span class="line"></span><br><span class="line">            DataManager.heroFighterChoise.alpha = <span class="number">0.7</span>;</span><br><span class="line">            DataManager.heroFighterChoise.sleep = <span class="literal">true</span>;</span><br><span class="line">            DataManager.heroFighterChoise.children[<span class="number">2</span>].alpha = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            alert(<span class="string">"我方的"</span>+DataManager.heroFighterChoise.cnName+<span class="string">"攻击了敌人英雄"</span>);</span><br><span class="line"></span><br><span class="line">            DataManager.heroFighterChoise = <span class="literal">null</span>;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="number">123</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pic;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">utils.extend(EnemyHead, Head);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = EnemyHead;</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/SangLiang/Blog/gh-pages/pics/201609/32.gif" alt="image"></p>
<p>如图，基本的玩家战斗逻辑就搞定了。不过接下来我们还有几件事情要做。</p>
<ul>
<li>费用的管理</li>
<li>AI的随从操作</li>
<li>补牌逻辑</li>
<li>剩余卡牌的展示</li>
<li>其他的完善工作</li>
</ul>
<h4 id="5-水晶的管理"><a href="#5-水晶的管理" class="headerlink" title="5.水晶的管理"></a>5.水晶的管理</h4><p>前面我们已经完成了基本的一些战斗逻辑，但是如果玩家可以一次性把所有的手牌打光，这明显是不合理的。在炉石的游戏中，每个随从都是和水晶费用相关联的，而之前我们已经声明好了Fee.js这个类及其子类，接下来我们要使他发挥其真正的作用。</p>
<p>打开我们的Fee.js:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 费用管理类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Fee</span>(<span class="params">game, x, y</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.feeObj = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.x = x || game.world.width - <span class="number">30</span>;</span><br><span class="line">    <span class="keyword">this</span>.y = y || <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.init(game);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Fee.prototype.init = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.feeObj = <span class="keyword">this</span>.setFeePic(game);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置Fee背景以及文字</span></span><br><span class="line">Fee.prototype.setFeePic = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> fee = game.add.image(<span class="keyword">this</span>.x, <span class="keyword">this</span>.y, <span class="string">"fee"</span>);</span><br><span class="line">    <span class="keyword">var</span> text = game.add.text(<span class="number">60</span>, <span class="number">28</span>, <span class="string">"1/1"</span>, &#123; <span class="attr">fill</span>: <span class="string">"#fff"</span>, <span class="attr">fontSize</span>: <span class="string">"18pt"</span> &#125;);</span><br><span class="line">    text.anchor.set(<span class="number">0.5</span>);</span><br><span class="line">    fee.addChild(text);</span><br><span class="line">    <span class="keyword">return</span> text;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = Fee;</span><br></pre></td></tr></table></figure>
<p>这里我们所做的改动不多，只是将初始化的显示数值由之前的”9/9”改成了”1/1”。打开DataManager.js，我们要加几个数据字段进去：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">heroCurrentFee: <span class="number">1</span>, <span class="comment">// 玩家当前费用</span></span><br><span class="line">enemyCurrentFee: <span class="number">1</span>, <span class="comment">// 敌人当前费用</span></span><br></pre></td></tr></table></figure>
<p>打开UIManager.js:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * UI界面管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> BackGround = <span class="built_in">require</span>(<span class="string">"./BackGround"</span>);</span><br><span class="line"><span class="keyword">var</span> HeroHead = <span class="built_in">require</span>(<span class="string">"./HeroHead"</span>);</span><br><span class="line"><span class="keyword">var</span> EnemyHead = <span class="built_in">require</span>(<span class="string">"./EnemyHead"</span>);</span><br><span class="line"><span class="keyword">var</span> DataManager = <span class="built_in">require</span>(<span class="string">"./DataManager"</span>);</span><br><span class="line"><span class="keyword">var</span> HeroHandCard = <span class="built_in">require</span>(<span class="string">"./HeroHandCard"</span>);</span><br><span class="line"><span class="keyword">var</span> EnemyHandCard = <span class="built_in">require</span>(<span class="string">"./EnemyHandCard"</span>);</span><br><span class="line"><span class="keyword">var</span> HeroFee = <span class="built_in">require</span>(<span class="string">"./HeroFee"</span>);</span><br><span class="line"><span class="keyword">var</span> EnemyFee = <span class="built_in">require</span>(<span class="string">"./EnemyFee"</span>);</span><br><span class="line"><span class="keyword">var</span> AI = <span class="built_in">require</span>(<span class="string">"./AI"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> HeroFighter = <span class="built_in">require</span>(<span class="string">"./HeroFighter"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UIManager</span>(<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.backgroundObj = <span class="literal">null</span>; <span class="comment">// 背景图</span></span><br><span class="line">    <span class="keyword">this</span>.turnOverButton = <span class="literal">null</span>; <span class="comment">// 回合结束</span></span><br><span class="line">    <span class="keyword">this</span>.shotCardButton = <span class="literal">null</span>; <span class="comment">// 出牌按钮</span></span><br><span class="line">    <span class="keyword">this</span>.init(game);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">UIManager.prototype.init = <span class="function"><span class="keyword">function</span>(<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.backgroundObj = <span class="keyword">this</span>.setBackGround(game); <span class="comment">// 生成背景图</span></span><br><span class="line"></span><br><span class="line">    DataManager.heroHead = <span class="keyword">new</span> HeroHead(game, <span class="string">"fighter_hero"</span>, <span class="number">0</span>, game.world.height - <span class="number">140</span>); <span class="comment">// 生成玩家英雄头像</span></span><br><span class="line">    DataManager.enemyHead = <span class="keyword">new</span> EnemyHead(game, <span class="string">"fighter_hero"</span>, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">// 生成电脑英雄头像</span></span><br><span class="line"></span><br><span class="line">    DataManager.turnOverButton = <span class="keyword">this</span>.setTurnOverButton(game); <span class="comment">// 设置回合结束按钮</span></span><br><span class="line"></span><br><span class="line">    DataManager.enemyHandCard = <span class="keyword">new</span> EnemyHandCard(game); <span class="comment">// 设置敌人手牌</span></span><br><span class="line">    <span class="built_in">console</span>.log(DataManager.enemyHandCard);</span><br><span class="line">    DataManager.heroHandCard = <span class="keyword">new</span> HeroHandCard(game, <span class="literal">null</span>, game.world.height - <span class="number">120</span>); <span class="comment">// 设置玩家手牌</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.shotCardButton = <span class="keyword">this</span>.setShotCardButton(game); <span class="comment">// 设置出牌按钮</span></span><br><span class="line"></span><br><span class="line">    DataManager.heroFee = <span class="keyword">new</span> HeroFee(game, game.world.width - <span class="number">110</span>, game.world.centerY + <span class="number">42</span>); <span class="comment">// 英雄费用管理</span></span><br><span class="line">    DataManager.enemyFee = <span class="keyword">new</span> EnemyFee(game, game.world.width - <span class="number">110</span>, game.world.centerY - <span class="number">90</span>); <span class="comment">// 敌人费用管理</span></span><br><span class="line"></span><br><span class="line">    DataManager.AI = <span class="keyword">new</span> AI(); <span class="comment">// 创建AI</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置背景</span></span><br><span class="line">UIManager.prototype.setBackGround = <span class="function"><span class="keyword">function</span>(<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> background = <span class="keyword">new</span> BackGround(game);</span><br><span class="line">    <span class="keyword">return</span> background;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 回合结束</span></span><br><span class="line">UIManager.prototype.setTurnOverButton = <span class="function"><span class="keyword">function</span>(<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> button = game.add.image(game.world.width - <span class="number">150</span>, game.world.centerY - <span class="number">30</span>, <span class="string">"hero_turn_button"</span>);</span><br><span class="line">    button.inputEnabled = <span class="literal">true</span>;</span><br><span class="line">    button.events.onInputDown.add(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DataManager.turn == <span class="number">0</span>) &#123;</span><br><span class="line">            button.loadTexture(<span class="string">"enemy_turn_button"</span>);</span><br><span class="line">            DataManager.turn = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DataManager.enemyFighters) &#123;</span><br><span class="line">            DataManager.enemyFighters.awakeFighter(); <span class="comment">// 解除敌人随从睡眠状态</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DataManager.enemyFee.feeObj.setText(DataManager.fee + <span class="string">"/"</span> + DataManager.fee);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> time = setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            DataManager.AI.shotCard(game);</span><br><span class="line">            <span class="keyword">if</span> (DataManager.heroFighters) &#123;</span><br><span class="line">                DataManager.heroFighters.awakeFighter(); <span class="comment">// 解除玩家随从睡眠状态</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 更新玩家费用的情况</span></span><br><span class="line">            DataManager.fee += <span class="number">1</span>;</span><br><span class="line">            DataManager.heroCurrentFee = DataManager.fee;</span><br><span class="line">            DataManager.heroFee.feeObj.setText(DataManager.fee + <span class="string">"/"</span> + DataManager.fee);</span><br><span class="line">            clearTimeout(time);</span><br><span class="line">        &#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> button;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 出牌按钮</span></span><br><span class="line">UIManager.prototype.setShotCardButton = <span class="function"><span class="keyword">function</span>(<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> shot = game.add.image(<span class="number">80</span>, game.world.centerY - <span class="number">10</span>, <span class="string">"shot_card"</span>);</span><br><span class="line">    shot.anchor.set(<span class="number">0.5</span>);</span><br><span class="line">    shot.inputEnabled = <span class="literal">true</span>;</span><br><span class="line">    shot.events.onInputDown.add(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DataManager.turn != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"我出牌了"</span>);</span><br><span class="line">        <span class="keyword">if</span> (DataManager.heroChoiseCard) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 检查选择卡牌的费用是否超出当前可用费用</span></span><br><span class="line">            <span class="keyword">if</span> (DataManager.heroCurrentFee &lt; DataManager.heroChoiseCard.cardInfo.fee) &#123;</span><br><span class="line">                alert(<span class="string">"你的费用不足，无法使用这张卡牌"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            DataManager.heroCurrentFee = DataManager.heroCurrentFee - DataManager.heroChoiseCard.cardInfo.fee;</span><br><span class="line">            DataManager.heroFee.feeObj.setText(DataManager.heroCurrentFee + <span class="string">"/"</span> + DataManager.fee);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DataManager.heroFighters == <span class="literal">null</span>) &#123;</span><br><span class="line">                DataManager.heroFighters = <span class="keyword">new</span> HeroFighter(game);</span><br><span class="line">                DataManager.heroFighters.buildFighter(game, DataManager.heroChoiseCard.cardInfo.HP, DataManager.heroChoiseCard.cardInfo.attack, DataManager.heroChoiseCard.cardInfo.cnName, DataManager.heroChoiseCard.cardInfo.fight);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                DataManager.heroFighters.buildFighter(game, DataManager.heroChoiseCard.cardInfo.HP, DataManager.heroChoiseCard.cardInfo.attack, DataManager.heroChoiseCard.cardInfo.cnName, DataManager.heroChoiseCard.cardInfo.fight);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            DataManager.heroChoiseCard.destroy();</span><br><span class="line">            DataManager.heroHandCard.reListHandCard();</span><br><span class="line">            DataManager.heroChoiseCard = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> shot;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = UIManager;</span><br></pre></td></tr></table></figure>
<p>水晶的逻辑主要是在出牌按钮之中，只有符合要求的卡牌才能被成功打出，水晶的更新主要是在回合结束的按钮之中完成，当敌人回合结束之后，玩家的水晶会被重置并上限加一，玩家的回合结束，那么敌人的水晶也会执行同样的逻辑。</p>
<p>水晶的控制也算是完成了。但是到这里我们发现，我们的电脑AI虽然会出牌了，随从却并没有采取果任何行动，像个木头人一样，这怎么行，这样的对战也是太无趣了。这里我们来开始写一点简单的AI进攻的逻辑。</p>
<p>打开AI.js:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 电脑AI</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> DataManager = <span class="built_in">require</span>(<span class="string">"./DataManager"</span>);</span><br><span class="line"><span class="keyword">var</span> EnemyFighter = <span class="built_in">require</span>(<span class="string">"./EnemyFighter"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AI</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.enemyChoise = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 出牌</span></span><br><span class="line">AI.prototype.shotCard = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.enemyChoise = <span class="keyword">this</span>.choiseCard();</span><br><span class="line">    DataManager.turn = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.enemyChoise) &#123;</span><br><span class="line">        <span class="comment">// 没有合适的卡牌</span></span><br><span class="line">        DataManager.turnOverButton.loadTexture(<span class="string">"hero_turn_button"</span>);</span><br><span class="line">        alert(<span class="string">"敌人选择不出牌,不知道有什么阴谋诡计"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DataManager.enemyFighters == <span class="literal">null</span>) &#123;</span><br><span class="line">        DataManager.enemyFighters = <span class="keyword">new</span> EnemyFighter(game);</span><br><span class="line">        DataManager.enemyFighters.buildFighter(game, <span class="keyword">this</span>.enemyChoise.cardInfo.HP, <span class="keyword">this</span>.enemyChoise.cardInfo.attack, <span class="keyword">this</span>.enemyChoise.cardInfo.cnName, <span class="keyword">this</span>.enemyChoise.cardInfo.fight);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        DataManager.enemyFighters.buildFighter(game, <span class="keyword">this</span>.enemyChoise.cardInfo.HP, <span class="keyword">this</span>.enemyChoise.cardInfo.attack, <span class="keyword">this</span>.enemyChoise.cardInfo.cnName, <span class="keyword">this</span>.enemyChoise.cardInfo.fight);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.enemyChoise.destroy();</span><br><span class="line">    DataManager.enemyHandCard.reListHandCard();</span><br><span class="line">    <span class="keyword">this</span>.enemyChoise = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    DataManager.turnOverButton.loadTexture(<span class="string">"hero_turn_button"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 选择手牌</span></span><br><span class="line">AI.prototype.choiseCard = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> shotList = [];</span><br><span class="line">    <span class="keyword">var</span> _fee = <span class="built_in">parseInt</span>(DataManager.enemyFee.feeObj.text.split(<span class="string">"/"</span>)[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; DataManager.enemyHandCard.cardViewList.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_fee &gt;= DataManager.enemyHandCard.cardViewList[i].cardInfo.fee) &#123;</span><br><span class="line">            <span class="comment">// 只要费用允许，就放入可出的牌之中</span></span><br><span class="line">            shotList.push(DataManager.enemyHandCard.cardViewList[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shotList.length &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(shotList);</span><br><span class="line">        <span class="comment">// 返回左手第一张牌</span></span><br><span class="line">        <span class="keyword">return</span> shotList[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 选择要攻击的目标</span></span><br><span class="line">AI.prototype.choiseAttackTarget = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 敌人没有随从</span></span><br><span class="line">    <span class="keyword">if</span> (!DataManager.enemyFighters || DataManager.enemyFighters.fightObj.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(DataManager.enemyFighters);</span><br><span class="line">    <span class="keyword">if</span> (!DataManager.heroFighters) &#123; <span class="comment">// 判断玩家的随从是否存在</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; DataManager.enemyFighters.fightObj.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DataManager.enemyFighters.fightObj[i].sleep == <span class="literal">false</span>) &#123;</span><br><span class="line">                alert(<span class="string">"敌人的"</span> + DataManager.enemyFighters.fightObj[i].cnName + <span class="string">"攻击了你的英雄"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新攻击之后的状态</span></span><br><span class="line">                DataManager.enemyFighters.fightObj[i].sleep = <span class="literal">true</span>;</span><br><span class="line">                DataManager.enemyFighters.fightObj[i].alpha = <span class="number">0.7</span>;</span><br><span class="line">                DataManager.heroHead.HPObj.setText(<span class="built_in">parseInt</span>(DataManager.heroHead.HPObj.text) - DataManager.enemyFighters.fightObj[i].attack);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> _heroFightersAttack = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">var</span> _enemyFightersAttack = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算电脑AI的场攻</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; DataManager.enemyFighters.fightObj.length; j++) &#123;</span><br><span class="line">            _enemyFightersAttack += DataManager.enemyFighters.fightObj[j].attack;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算玩家战场上的场攻</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> k = <span class="number">0</span>; k &lt; DataManager.heroFighters.fightObj.length; k++) &#123;</span><br><span class="line">            _heroFightersAttack += DataManager.heroFighters.fightObj[k].attack;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> _destroyList = [];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; DataManager.enemyFighters.fightObj.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DataManager.enemyFighters.fightObj[i].sleep == <span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"attack"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (_enemyFightersAttack &gt;= _heroFightersAttack) &#123; <span class="comment">// AI场攻大于玩家随从的场攻</span></span><br><span class="line">                    alert(<span class="string">"敌人的"</span> + DataManager.enemyFighters.fightObj[i].cnName + <span class="string">"攻击了你的英雄"</span>);</span><br><span class="line">                    <span class="comment">// 更新攻击之后的状态</span></span><br><span class="line">                    DataManager.enemyFighters.fightObj[i].sleep = <span class="literal">true</span>;</span><br><span class="line">                    DataManager.enemyFighters.fightObj[i].alpha = <span class="number">0.7</span>;</span><br><span class="line">                    DataManager.heroHead.HPObj.setText(<span class="built_in">parseInt</span>(DataManager.heroHead.HPObj.text) - DataManager.enemyFighters.fightObj[i].attack);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// AI场攻小于玩家场攻则攻击随从</span></span><br><span class="line">                    alert(<span class="string">"敌方的"</span> + DataManager.enemyFighters.fightObj[i].cnName + <span class="string">"攻击了我方的"</span> + DataManager.heroFighters.fightObj[<span class="number">0</span>].cnName);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> _heroFightHP = DataManager.enemyFighters.fightObj[i].hp - DataManager.heroFighters.fightObj[<span class="number">0</span>].attack;</span><br><span class="line">                    <span class="keyword">var</span> _enemyFightHP = DataManager.heroFighters.fightObj[<span class="number">0</span>].hp - DataManager.enemyFighters.fightObj[i].attack;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 更新玩家的随从的hp</span></span><br><span class="line">                    DataManager.enemyFighters.fightObj[i].hp = _heroFightHP;</span><br><span class="line">                    DataManager.enemyFighters.fightObj[i].alpha = <span class="number">0.7</span>;</span><br><span class="line">                    DataManager.enemyFighters.fightObj[i].sleep = <span class="literal">true</span>;</span><br><span class="line">                    DataManager.enemyFighters.fightObj[i].children[<span class="number">2</span>].alpha = <span class="number">0</span>;</span><br><span class="line">                    DataManager.enemyFighters.fightObj[i].children[<span class="number">1</span>].setText(_heroFightHP);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 更新敌人的玩家的hp</span></span><br><span class="line">                    DataManager.heroFighters.fightObj[<span class="number">0</span>].hp = _enemyFightHP;</span><br><span class="line">                    DataManager.heroFighters.fightObj[<span class="number">0</span>].children[<span class="number">1</span>].setText(_enemyFightHP);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (_heroFightHP &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        _destroyList.push(DataManager.enemyFighters.fightObj[i]);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (_enemyFightHP &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        DataManager.heroFighters.fightObj[<span class="number">0</span>].destroy();</span><br><span class="line">                        DataManager.heroFighters.reListObjs();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> n = <span class="number">0</span>; n &lt; _destroyList.length; n++) &#123;</span><br><span class="line">            _destroyList[n].destroy();</span><br><span class="line">        &#125;</span><br><span class="line">        DataManager.enemyFighters.reListObjs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = AI;</span><br></pre></td></tr></table></figure>
<p>这里的AI逻辑很简单，首先对场上的随从的场攻进行一个判断，如果AI方的场攻大于玩家方的，那么AI就可以肆无忌惮的攻击玩家的英雄本体了，如果小于，则需要攻击玩家的随从来降低场攻，不过对随从的选择还是比较简单的，只是选择了战场随从的第一个来作为目标。如果你希望AI看起来更加聪明一点可以计算下玩家场上攻击力最高的随从，如果最高的攻击力随从死掉之后，再计算下双方的场攻，然后重复上面的逻辑。</p>
<p>最后放上玩家的补牌逻辑和电脑的补牌逻辑,玩家：打开HandCard.js加入addCard这个方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 回合开始时的补牌逻辑</span></span><br><span class="line">HandCard.prototype.addCard = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _cardList = <span class="keyword">this</span>.cardIDList.splice(<span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(_cardList);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; CardConfig.card_info.length; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_cardList[<span class="number">0</span>] == CardConfig.card_info[j].id) &#123;</span><br><span class="line">            <span class="keyword">var</span> card = game.add.image(<span class="keyword">this</span>.x + (<span class="keyword">this</span>.cardObjList.length) * <span class="number">75</span>, <span class="keyword">this</span>.y, CardConfig.card_info[j].name);</span><br><span class="line">            card.cardInfo = &#123;&#125;;</span><br><span class="line">            card.cardInfo.HP = CardConfig.card_info[j].hp; <span class="comment">// 血量</span></span><br><span class="line">            card.cardInfo.attack = CardConfig.card_info[j].attack; <span class="comment">// 攻击力</span></span><br><span class="line">            card.cardInfo.cnName = CardConfig.card_info[j].cn_name; <span class="comment">// 中文名称</span></span><br><span class="line">            card.cardInfo.fee = CardConfig.card_info[j].fee; <span class="comment">// 召唤费用</span></span><br><span class="line">            card.cardInfo.fight = CardConfig.card_info[j].fight; <span class="comment">// 战斗图片</span></span><br><span class="line">            card.scale.set(<span class="number">0.5</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.cardObjList.push(card);</span><br><span class="line"></span><br><span class="line">            card.inputEnabled = <span class="literal">true</span>;</span><br><span class="line">            card.events.onInputDown.add(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">this</span>.inputEnabled = <span class="literal">false</span>; <span class="comment">// 禁止玩家不停点击</span></span><br><span class="line">                <span class="keyword">if</span> (DataManager.heroChoiseCard == <span class="literal">null</span>) &#123;</span><br><span class="line">                    DataManager.heroChoiseCard = <span class="keyword">this</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 注册动画事件</span></span><br><span class="line">                    <span class="keyword">var</span> tween = game.add.tween(DataManager.heroChoiseCard).to(&#123; <span class="attr">y</span>: DataManager.heroChoiseCard.y + <span class="number">20</span> &#125;, <span class="number">200</span>, <span class="string">"Linear"</span>, <span class="literal">true</span>);</span><br><span class="line">                    DataManager.heroChoiseCard.inputEnabled = <span class="literal">true</span>;</span><br><span class="line">                    <span class="comment">// 执行动画</span></span><br><span class="line">                    tween.start();</span><br><span class="line">                    DataManager.heroChoiseCard = <span class="keyword">this</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> tween = game.add.tween(<span class="keyword">this</span>).to(&#123; <span class="attr">y</span>: <span class="keyword">this</span>.y - <span class="number">20</span> &#125;, <span class="number">200</span>, <span class="string">"Linear"</span>, <span class="literal">true</span>);</span><br><span class="line">                tween.start();</span><br><span class="line">                tween.onComplete.add(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;, card);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>然后电脑的AI的补牌逻辑我们写在EnemyHandCard类之中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 敌人的手牌类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> HandCarnd = <span class="built_in">require</span>(<span class="string">"./HandCard"</span>);</span><br><span class="line"><span class="keyword">var</span> utils = <span class="built_in">require</span>(<span class="string">"../Utils"</span>);</span><br><span class="line"><span class="keyword">var</span> CardConfig = <span class="built_in">require</span>(<span class="string">"../config/CardConfig"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">EnemyHandCard</span>(<span class="params">game</span>) </span>&#123;</span><br><span class="line">    HandCarnd.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    <span class="comment">// this.setRealHandCard(game); // 真实卡面</span></span><br><span class="line">    <span class="keyword">this</span>.buildHandCardViewList(game); <span class="comment">// 设置卡背</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">utils.extend(EnemyHandCard, HandCarnd);</span><br><span class="line"></span><br><span class="line"><span class="comment">// @override  </span></span><br><span class="line"><span class="comment">// 重写relistHandCard方法</span></span><br><span class="line">EnemyHandCard.prototype.reListHandCard = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> _temp = [];</span><br><span class="line">    <span class="built_in">console</span>.log(self.cardViewList);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (self.cardViewList.length == <span class="number">0</span>) &#123; <span class="comment">// 没有手牌的情况</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; self.cardViewList.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (self.cardViewList[i].alive == <span class="literal">true</span>) &#123; <span class="comment">// 清除掉已经销毁了的手牌</span></span><br><span class="line">                _temp.push(self.cardViewList[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        self.cardViewList = _temp;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; self.cardViewList.length; j++) &#123; <span class="comment">// 重新对手牌排序</span></span><br><span class="line">            self.cardViewList[j].x = self.x + j * <span class="number">70</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// @override </span></span><br><span class="line"><span class="comment">// 重写回合开始时的补牌逻辑</span></span><br><span class="line">EnemyHandCard.prototype.addCard = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _cardList = <span class="keyword">this</span>.cardIDList.splice(<span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(_cardList);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; CardConfig.card_info.length; j++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_cardList[<span class="number">0</span>] == CardConfig.card_info[j].id) &#123;</span><br><span class="line">            <span class="keyword">var</span> card = game.add.image(<span class="keyword">this</span>.x + <span class="keyword">this</span>.cardViewList.length * <span class="number">70</span>, <span class="keyword">this</span>.y, <span class="string">"card_back"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置相应的数据</span></span><br><span class="line">            card.cardInfo = &#123;&#125;;</span><br><span class="line">            card.cardInfo.HP = CardConfig.card_info[j].hp; <span class="comment">// 血量</span></span><br><span class="line">            card.cardInfo.attack = CardConfig.card_info[j].attack; <span class="comment">// 攻击力</span></span><br><span class="line">            card.cardInfo.cnName = CardConfig.card_info[j].cn_name; <span class="comment">// 中文名称</span></span><br><span class="line">            card.cardInfo.fee = CardConfig.card_info[j].fee; <span class="comment">// 召唤费用</span></span><br><span class="line">            card.cardInfo.fight = CardConfig.card_info[j].fight; <span class="comment">// 战斗图片</span></span><br><span class="line">            card.scale.set(<span class="number">0.5</span>);</span><br><span class="line">            <span class="keyword">this</span>.cardViewList.push(card);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = EnemyHandCard;</span><br></pre></td></tr></table></figure>
<p>最后记得在UIManager中去执行这两个方法，让玩家在出牌之前记得先补充一张手牌：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 回合结束</span></span><br><span class="line">UIManager.prototype.setTurnOverButton = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> button = game.add.image(game.world.width - <span class="number">150</span>, game.world.centerY - <span class="number">30</span>, <span class="string">"hero_turn_button"</span>);</span><br><span class="line">    button.inputEnabled = <span class="literal">true</span>;</span><br><span class="line">    button.events.onInputDown.add(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DataManager.turn == <span class="number">0</span>) &#123;</span><br><span class="line">            button.loadTexture(<span class="string">"enemy_turn_button"</span>);</span><br><span class="line">            DataManager.turn = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DataManager.enemyFighters) &#123;</span><br><span class="line">            DataManager.enemyFighters.awakeFighter(); <span class="comment">// 解除敌人随从睡眠状态</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DataManager.enemyFee.feeObj.setText(DataManager.fee + <span class="string">"/"</span> + DataManager.fee);</span><br><span class="line">        DataManager.enemyHandCard.addCard(game); <span class="comment">// 敌人摸牌</span></span><br><span class="line">        <span class="keyword">var</span> time = setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            DataManager.AI.shotCard(game);</span><br><span class="line">            DataManager.AI.choiseAttackTarget(); <span class="comment">// 电脑AI展开攻击</span></span><br><span class="line">            <span class="keyword">if</span> (DataManager.heroFighters) &#123;</span><br><span class="line">                DataManager.heroFighters.awakeFighter(); <span class="comment">// 解除玩家随从睡眠状态</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 更新玩家费用的情况</span></span><br><span class="line">            DataManager.fee += <span class="number">1</span>;</span><br><span class="line">            DataManager.heroCurrentFee = DataManager.fee;</span><br><span class="line">            DataManager.heroFee.feeObj.setText(DataManager.fee + <span class="string">"/"</span> + DataManager.fee);</span><br><span class="line">            DataManager.heroHandCard.addCard(game); <span class="comment">// 玩家摸牌</span></span><br><span class="line">            clearTimeout(time);</span><br><span class="line">        &#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> button;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里，游戏的主要逻辑就走完了。不过游戏并没有完成。我们还有一些收尾工作要做。</p>
<p>比如我们要限制场上的随从的数量，要限制手牌的数量，牌库里的卡牌用完后的处理，还有当玩家或电脑AI的生命值降为0时游戏结束的判定。</p>
<p>先看下对场上随从数量的限制，打开UIManager.js，在其中的setShotCardButton方法中加入:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 控制玩家场上的随从</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (DataManager.heroFighters.fightObj.length &gt;= <span class="number">5</span>) &#123;</span><br><span class="line">        alert(<span class="string">"您场上的随从已经到达了上限"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样的，在AI.js类中也找到AI的出牌方法shotCard，加上:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (DataManager.enemyFighters.fightObj.length &gt;= <span class="number">5</span>) &#123;</span><br><span class="line">        DataManager.turnOverButton.loadTexture(<span class="string">"hero_turn_button"</span>);</span><br><span class="line">        alert(<span class="string">"敌人选择不出牌,不知道有什么阴谋诡计"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后补牌逻辑的判定和上述的方法类似，只要判断手牌是否大于8张，如果大于或者等于8张，那么抽到的卡牌就无法再加入到手牌之中，也就是会被摧毁掉。</p>
<p>打开HandCard.js类,在addCard方法中加上:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.cardObjList.length &gt;= <span class="number">8</span>) &#123;</span><br><span class="line">    alert(<span class="string">"你的手牌已达到上限，当前到的卡牌被销毁"</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>EnemyHandCard因为重写了addCard方法，所以我们在EnemyHandCard中也这样做一次就可以了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.cardViewList.length &gt;= <span class="number">8</span>) &#123;</span><br><span class="line">    alert(<span class="string">"敌人已达到上限，当前到的卡牌被销毁"</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，一些基本卡组的限制就做完了。别忘了，我们还剩一件事情没做。那就试关于游戏胜负的结算。</p>
<p>我们新建一个场景,ResultScene.js:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  游戏结果场景</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> DataManager = <span class="built_in">require</span>(<span class="string">"../class/DataManager"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ResultScene</span>(<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.create = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DataManager.result == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"敌人胜利"</span>);</span><br><span class="line">            <span class="keyword">var</span> text = game.add.text(game.world.centerX, game.world.centerY, <span class="string">"You Loss"</span>, &#123;</span><br><span class="line">                fill: <span class="string">"#000"</span>,</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            text.anchor.set(<span class="number">0.5</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> text = game.add.text(game.world.centerX, game.world.centerY, <span class="string">"You Win"</span>, &#123;</span><br><span class="line">                fill: <span class="string">"#000"</span>,</span><br><span class="line">                fontSize: <span class="string">"30pt"</span></span><br><span class="line">            &#125;);</span><br><span class="line">            text.anchor.set(<span class="number">0.5</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = ResultScene;</span><br></pre></td></tr></table></figure>
<p>然后在我们main.js中加入这个场景：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> StartScene = <span class="built_in">require</span>(<span class="string">"./modules/scenes/StartScene"</span>);</span><br><span class="line"><span class="keyword">var</span> GameScene = <span class="built_in">require</span>(<span class="string">"./modules/scenes/GameScene"</span>);</span><br><span class="line"><span class="keyword">var</span> ResultScene = <span class="built_in">require</span>(<span class="string">"./modules/scenes/ResultScene"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> game = <span class="keyword">new</span> Phaser.Game(<span class="number">800</span>, <span class="number">600</span>, Phaser.AUTO, <span class="string">'mainCanvas'</span>, &#123;&#125;, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">game.state.add(<span class="string">"StartScene"</span>, StartScene);  <span class="comment">// 游戏开始场景</span></span><br><span class="line">game.state.add(<span class="string">"GameScene"</span>, GameScene);    <span class="comment">// 游戏场景</span></span><br><span class="line">game.state.add(<span class="string">"ResultScene"</span>, ResultScene); <span class="comment">// 游戏结果场景</span></span><br><span class="line">game.state.start(<span class="string">"StartScene"</span>);</span><br></pre></td></tr></table></figure>
<p>最后在结算中加入我们的触发函数，打开EnemnyHead.js:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 敌人头像</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> utils = <span class="built_in">require</span>(<span class="string">"../Utils"</span>);</span><br><span class="line"><span class="keyword">var</span> Head = <span class="built_in">require</span>(<span class="string">"./Head"</span>);</span><br><span class="line"><span class="keyword">var</span> DataManager = <span class="built_in">require</span>(<span class="string">"./DataManager"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">EnemyHead</span>(<span class="params">game, textureName, positionX, positionY</span>) </span>&#123;</span><br><span class="line">    Head.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置敌人头像</span></span><br><span class="line"><span class="comment">// @override重写setPic</span></span><br><span class="line">Head.prototype.setPic = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> pic = game.add.image(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">this</span>.textureName);</span><br><span class="line"></span><br><span class="line">    pic.inputEnabled = <span class="literal">true</span>;</span><br><span class="line">    pic.events.onInputDown.add(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DataManager.heroFighterChoise == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> _hp = <span class="built_in">parseInt</span>(<span class="keyword">this</span>.HPObj.text) - DataManager.heroFighterChoise.attack;</span><br><span class="line">            <span class="keyword">this</span>.HPObj.setText(_hp);</span><br><span class="line"></span><br><span class="line">            DataManager.heroFighterChoise.alpha = <span class="number">0.7</span>;</span><br><span class="line">            DataManager.heroFighterChoise.sleep = <span class="literal">true</span>;</span><br><span class="line">            DataManager.heroFighterChoise.children[<span class="number">2</span>].alpha = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            alert(<span class="string">"我方的"</span> + DataManager.heroFighterChoise.cnName + <span class="string">"攻击了敌人英雄"</span>);</span><br><span class="line"></span><br><span class="line">            DataManager.heroFighterChoise = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">parseInt</span>(<span class="keyword">this</span>.HPObj.text) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                alert(<span class="string">"玩家获取胜利，敌人阵亡"</span>);</span><br><span class="line">                DataManager.result = <span class="number">1</span>;</span><br><span class="line">                game.state.start(<span class="string">"ResultScene"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pic;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">utils.extend(EnemyHead, Head);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = EnemyHead;</span><br></pre></td></tr></table></figure>
<p>AI.js:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 电脑AI</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> DataManager = <span class="built_in">require</span>(<span class="string">"./DataManager"</span>);</span><br><span class="line"><span class="keyword">var</span> EnemyFighter = <span class="built_in">require</span>(<span class="string">"./EnemyFighter"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AI</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.enemyChoise = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 出牌</span></span><br><span class="line">AI.prototype.shotCard = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.enemyChoise = <span class="keyword">this</span>.choiseCard();</span><br><span class="line">    DataManager.turn = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.enemyChoise) &#123;</span><br><span class="line">        <span class="comment">// 没有合适的卡牌</span></span><br><span class="line">        DataManager.turnOverButton.loadTexture(<span class="string">"hero_turn_button"</span>);</span><br><span class="line">        alert(<span class="string">"敌人选择不出牌,不知道有什么阴谋诡计"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DataManager.enemyFighters.fightObj.length &gt;= <span class="number">5</span>) &#123;</span><br><span class="line">            DataManager.turnOverButton.loadTexture(<span class="string">"hero_turn_button"</span>);</span><br><span class="line">            alert(<span class="string">"敌人选择不出牌,不知道有什么阴谋诡计"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DataManager.enemyFighters == <span class="literal">null</span>) &#123;</span><br><span class="line">        DataManager.enemyFighters = <span class="keyword">new</span> EnemyFighter(game);</span><br><span class="line">        DataManager.enemyFighters.buildFighter(game, <span class="keyword">this</span>.enemyChoise.cardInfo.HP, <span class="keyword">this</span>.enemyChoise.cardInfo.attack, <span class="keyword">this</span>.enemyChoise.cardInfo.cnName, <span class="keyword">this</span>.enemyChoise.cardInfo.fight);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        DataManager.enemyFighters.buildFighter(game, <span class="keyword">this</span>.enemyChoise.cardInfo.HP, <span class="keyword">this</span>.enemyChoise.cardInfo.attack, <span class="keyword">this</span>.enemyChoise.cardInfo.cnName, <span class="keyword">this</span>.enemyChoise.cardInfo.fight);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.enemyChoise.destroy();</span><br><span class="line">    DataManager.enemyHandCard.reListHandCard();</span><br><span class="line">    <span class="keyword">this</span>.enemyChoise = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    DataManager.turnOverButton.loadTexture(<span class="string">"hero_turn_button"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 选择手牌</span></span><br><span class="line">AI.prototype.choiseCard = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> shotList = [];</span><br><span class="line">    <span class="keyword">var</span> _fee = <span class="built_in">parseInt</span>(DataManager.enemyFee.feeObj.text.split(<span class="string">"/"</span>)[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; DataManager.enemyHandCard.cardViewList.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_fee &gt;= DataManager.enemyHandCard.cardViewList[i].cardInfo.fee) &#123;</span><br><span class="line">            <span class="comment">// 只要费用允许，就放入可出的牌之中</span></span><br><span class="line">            shotList.push(DataManager.enemyHandCard.cardViewList[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shotList.length &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 返回左手第一张牌</span></span><br><span class="line">        <span class="keyword">return</span> shotList[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 选择要攻击的目标</span></span><br><span class="line">AI.prototype.choiseAttackTarget = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 敌人没有随从</span></span><br><span class="line">    <span class="keyword">if</span> (!DataManager.enemyFighters || DataManager.enemyFighters.fightObj.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DataManager.heroFighters == <span class="literal">null</span>) &#123; <span class="comment">// 判断玩家的随从是否存在</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; DataManager.enemyFighters.fightObj.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DataManager.enemyFighters.fightObj[i].sleep == <span class="literal">false</span>) &#123;</span><br><span class="line">                alert(<span class="string">"敌人的"</span> + DataManager.enemyFighters.fightObj[i].cnName + <span class="string">"攻击了你的英雄"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新攻击之后的状态</span></span><br><span class="line">                DataManager.enemyFighters.fightObj[i].sleep = <span class="literal">true</span>;</span><br><span class="line">                DataManager.enemyFighters.fightObj[i].alpha = <span class="number">0.7</span>;</span><br><span class="line">                DataManager.heroHead.HPObj.setText(<span class="built_in">parseInt</span>(DataManager.heroHead.HPObj.text) - DataManager.enemyFighters.fightObj[i].attack);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">parseInt</span>(DataManager.heroHead.HPObj.text) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    DataManager.result = <span class="number">0</span>;</span><br><span class="line">                    alert(<span class="string">"敌人获取了胜利，玩家阵亡"</span>);</span><br><span class="line">                    game.state.start(<span class="string">"ResultScene"</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> _heroFightersAttack = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">var</span> _enemyFightersAttack = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算电脑AI的场攻</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; DataManager.enemyFighters.fightObj.length; j++) &#123;</span><br><span class="line">            _enemyFightersAttack += DataManager.enemyFighters.fightObj[j].attack;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算玩家战场上的场攻</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> k = <span class="number">0</span>; k &lt; DataManager.heroFighters.fightObj.length; k++) &#123;</span><br><span class="line">            _heroFightersAttack += DataManager.heroFighters.fightObj[k].attack;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(_heroFightersAttack, _enemyFightersAttack);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> _destroyList = [];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; DataManager.enemyFighters.fightObj.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DataManager.enemyFighters.fightObj[i].sleep == <span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"attack"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (_enemyFightersAttack &gt;= _heroFightersAttack) &#123; <span class="comment">// AI场攻大于玩家随从的场攻</span></span><br><span class="line">                    alert(<span class="string">"敌人的"</span> + DataManager.enemyFighters.fightObj[i].cnName + <span class="string">"攻击了你的英雄"</span>);</span><br><span class="line">                    <span class="comment">// 更新攻击之后的状态</span></span><br><span class="line">                    DataManager.enemyFighters.fightObj[i].sleep = <span class="literal">true</span>;</span><br><span class="line">                    DataManager.enemyFighters.fightObj[i].alpha = <span class="number">0.7</span>;</span><br><span class="line">                    DataManager.heroHead.HPObj.setText(<span class="built_in">parseInt</span>(DataManager.heroHead.HPObj.text) - DataManager.enemyFighters.fightObj[i].attack);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">parseInt</span>(DataManager.heroHead.HPObj.text) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        DataManager.result = <span class="number">0</span>;</span><br><span class="line">                        alert(<span class="string">"敌人获取了胜利，玩家阵亡"</span>);</span><br><span class="line">                        game.state.start(<span class="string">"ResultScene"</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// AI场攻小于玩家场攻则攻击随从</span></span><br><span class="line">                    alert(<span class="string">"敌方的"</span> + DataManager.enemyFighters.fightObj[i].cnName + <span class="string">"攻击了我方的"</span> + DataManager.heroFighters.fightObj[<span class="number">0</span>].cnName);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> _heroFightHP = DataManager.enemyFighters.fightObj[i].hp - DataManager.heroFighters.fightObj[<span class="number">0</span>].attack;</span><br><span class="line">                    <span class="keyword">var</span> _enemyFightHP = DataManager.heroFighters.fightObj[<span class="number">0</span>].hp - DataManager.enemyFighters.fightObj[i].attack;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 更新玩家的随从的hp</span></span><br><span class="line">                    DataManager.enemyFighters.fightObj[i].hp = _heroFightHP;</span><br><span class="line">                    DataManager.enemyFighters.fightObj[i].alpha = <span class="number">0.7</span>;</span><br><span class="line">                    DataManager.enemyFighters.fightObj[i].sleep = <span class="literal">true</span>;</span><br><span class="line">                    DataManager.enemyFighters.fightObj[i].children[<span class="number">2</span>].alpha = <span class="number">0</span>;</span><br><span class="line">                    DataManager.enemyFighters.fightObj[i].children[<span class="number">1</span>].setText(_heroFightHP);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 更新敌人的玩家的hp</span></span><br><span class="line">                    DataManager.heroFighters.fightObj[<span class="number">0</span>].hp = _enemyFightHP;</span><br><span class="line">                    DataManager.heroFighters.fightObj[<span class="number">0</span>].children[<span class="number">1</span>].setText(_enemyFightHP);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (_heroFightHP &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        _destroyList.push(DataManager.enemyFighters.fightObj[i]);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (_enemyFightHP &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        DataManager.heroFighters.fightObj[<span class="number">0</span>].destroy();</span><br><span class="line">                        DataManager.heroFighters.reListObjs();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> n = <span class="number">0</span>; n &lt; _destroyList.length; n++) &#123;</span><br><span class="line">            _destroyList[n].destroy();</span><br><span class="line">        &#125;</span><br><span class="line">        DataManager.enemyFighters.reListObjs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = AI;</span><br></pre></td></tr></table></figure>
<p>到这里游戏的主要的逻辑都已经实现完毕了。现在完全可以和电脑来一局纯靠人品的战斗～</p>
<p><img src="https://raw.githubusercontent.com/SangLiang/Blog/gh-pages/pics/201609/33.gif" alt="image"></p>
<h3 id="六-小结"><a href="#六-小结" class="headerlink" title="六.小结"></a>六.小结</h3><p>教程在这里就告了一个段落了。但是不意味着游戏就已经结束了。还有一个简单的小功能，<strong>剩余卡牌的提示功能</strong>这里我就不再做了，如果对前面的文章有认真研究的同学，应该可以自己把这个功能开发出来。</p>
<h4 id="关于拓展："><a href="#关于拓展：" class="headerlink" title="关于拓展："></a>关于拓展：</h4><p>游戏的各个组件基本都是封装成了类的，游戏的主要逻辑是写在UIManager.js中的各个按钮事件的触发之中，所有驱动游戏进程的数据在DataManager.js中。如果你要把游戏拓展得比现有功能更加强大，更加完美那也是完全可行的。</p>
<p>最后，感谢各位的收看，整个项目托管地址在<a href="https://github.com/SangLiang/PhaserHearthStone" target="_blank" rel="noopener">这里</a>。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/Timing-House/tags/Phaser/" rel="tag"># Phaser</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/Timing-House/2017/04/16/使用Phaser来开发我的炉石传说(二)/" rel="next" title="使用Phaser来开发我的炉石传说(二)">
                <i class="fa fa-chevron-left"></i> 使用Phaser来开发我的炉石传说(二)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/Timing-House/2017/06/05/KNN邻近算法/" rel="prev" title="KNN邻近算法">
                KNN邻近算法 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/Timing-House/images/avatar.gif" alt="Sa">
          <p class="site-author-name" itemprop="name">Sa</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/Timing-House/archives">
                <span class="site-state-item-count">42</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Sangliang" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="378305868@qq.com" target="_blank" title="Email">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Email
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-战斗逻辑"><span class="nav-number">1.</span> <span class="nav-text">4.战斗逻辑</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-水晶的管理"><span class="nav-number">2.</span> <span class="nav-text">5.水晶的管理</span></a></li></ol><li class="nav-item nav-level-3"><a class="nav-link" href="#六-小结"><span class="nav-number"></span> <span class="nav-text">六.小结</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#关于拓展："><span class="nav-number">1.</span> <span class="nav-text">关于拓展：</span></a></li></ol></li></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sa</span>
</div>



        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  








  
  <script type="text/javascript" src="/Timing-House/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/Timing-House/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/Timing-House/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/Timing-House/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/Timing-House/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/Timing-House/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/Timing-House/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/Timing-House/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/Timing-House/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/Timing-House/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/Timing-House/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  

</body>
</html>
